<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Efici√™ncia Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Nunito+Sans:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --bg-body: #f4f7f9;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
        }
        .input-premium {
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: all 0.2s;
            outline: none;
            font-weight: 700;
        }
        .input-premium:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.1);
        }
        .label-forte {
            font-size: 0.75rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #1e293b;
            margin-bottom: 0.5rem;
            display: block;
        }
        .active-tab {
            color: var(--accent-color);
            border-bottom: 4px solid var(--accent-color);
            font-weight: 900;
        }
        .card-project {
            background: white;
            border-radius: 32px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .card-project:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
        }
        .status-pill {
            font-size: 0.65rem;
            font-weight: 900;
            padding: 4px 12px;
            border-radius: 100px;
            text-transform: uppercase;
        }
        .status-backlog { background-color: #e2e8f0; color: #475569; }
        .status-andamento { background-color: #fef3c7; color: #92400e; }
        .status-finalizado { background-color: #dcfce7; color: #166534; }
        .status-despriorizado { background-color: #fee2e2; color: #991b1b; }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .checkbox-item:hover { background: #f1f5f9; }

        .kpi-card {
            background: white;
            padding: 1.25rem;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border: 1px solid #f1f5f9;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s;
        }

        .btn-icon-add {
            background: #f1f5f9;
            color: #475569;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-weight: bold;
        }
        .btn-icon-add:hover {
            background: var(--accent-color);
            color: var(--primary-color);
        }

        .metrica-row {
            display: grid;
            grid-template-columns: 1.5fr 1fr 1fr 1.2fr 40px;
            gap: 12px;
            align-items: end;
        }

        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .main-content { margin: 0; padding: 0; }
        }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <div id="loading-overlay">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-32 mb-8 invert" alt="Unico">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
        <p class="text-[10px] uppercase font-bold tracking-widest mt-4 opacity-50 text-white text-center">Sincronizando ambiente Unico...</p>
    </div>

    <!-- Popup Excluir -->
    <div id="delete-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden items-center justify-center z-[12000] p-4 text-slate-800">
        <div class="bg-white w-full max-w-md p-10 rounded-[2.5rem] shadow-2xl text-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </div>
            <h3 class="text-xl font-black uppercase tracking-tighter mb-2 text-slate-800">Deseja excluir este projeto?</h3>
            <p class="text-slate-500 text-sm font-medium mb-8 text-slate-500 text-slate-500">Esta a√ß√£o √© permanente e os dados ser√£o removidos.</p>
            <div class="flex gap-3">
                <button id="confirm-delete-btn" class="bg-red-500 text-white font-black py-4 px-6 rounded-2xl flex-1 transition hover:bg-red-600 uppercase text-[10px] tracking-widest shadow-lg text-white">Sim, Excluir</button>
                <button onclick="window.closeDeleteModal()" class="bg-slate-100 text-slate-500 font-black py-4 px-6 rounded-2xl flex-1 transition hover:bg-slate-200 uppercase text-[10px] tracking-widest">N√£o</button>
            </div>
        </div>
    </div>

    <!-- Modais Din√¢micos -->
    <div id="custom-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[11000] p-4 text-slate-800">
        <div class="bg-white w-full max-w-sm p-8 rounded-[2.5rem] shadow-2xl">
            <h3 id="modal-title" class="text-xl font-black mb-4 uppercase tracking-tighter text-center">Adicionar Item</h3>
            <input type="text" id="modal-input" class="w-full input-premium mb-6" placeholder="Digite o nome...">
            <div class="flex gap-3">
                <button id="modal-confirm" class="bg-slate-900 text-white font-bold py-3 px-6 rounded-2xl flex-1 transition hover:bg-slate-800 uppercase text-[10px] tracking-widest">Adicionar</button>
                <button onclick="window.closeCustomModal()" class="bg-slate-100 text-slate-400 font-bold py-3 px-6 rounded-2xl flex-1 transition hover:bg-slate-200 uppercase text-[10px] tracking-widest">Sair</button>
            </div>
        </div>
    </div>

    <!-- Modal Report -->
    <div id="report-modal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden items-center justify-center z-[11000] p-4 text-slate-800">
        <div class="bg-white w-full max-w-2xl p-10 rounded-[2.5rem] shadow-2xl relative text-slate-800">
            <button onclick="window.closeReportModal()" class="absolute top-8 right-8 text-slate-300 hover:text-slate-900 transition text-2xl font-bold">√ó</button>
            <div>
                <span class="label-forte">Resumo de Status</span>
                <h3 class="text-2xl font-black uppercase tracking-tighter mb-6">Relat√≥rio da Iniciativa</h3>
                <div id="report-content" class="bg-slate-50 p-6 rounded-3xl border border-slate-100 mb-8 max-h-[40vh] overflow-y-auto">
                    <pre id="report-text" class="text-sm font-medium whitespace-pre-wrap leading-relaxed text-slate-700"></pre>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button onclick="window.sendReportByEmail()" class="bg-slate-900 text-white font-black py-4 px-6 rounded-2xl flex items-center justify-center gap-3 transition hover:bg-slate-800 uppercase text-[10px] tracking-widest text-white">Enviar por E-mail</button>
                    <button onclick="window.copyReportForSlack()" class="bg-[#4A154B] text-white font-black py-4 px-6 rounded-2xl flex items-center justify-center gap-3 transition hover:opacity-90 uppercase text-[10px] tracking-widest text-white">Slack</button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-6 h-20 flex justify-between items-center text-slate-800">
            <div class="flex items-center gap-6">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-8" alt="Unico Logo">
                <div id="sync-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                    <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[10px] font-black text-green-600 uppercase">Tempo Real</span>
                </div>
            </div>
            <nav class="flex gap-8 h-full items-center text-[11px] font-black uppercase tracking-widest text-slate-400">
                <button onclick="window.switchTab('dashboard')" id="tab-dashboard" class="h-full px-2 active-tab transition-colors">Dashboard</button>
                <button onclick="window.switchTab('form')" id="tab-form" class="h-full px-2 hover:text-slate-900 transition-colors text-slate-800">Novo Projeto</button>
                <button onclick="window.switchTab('list')" id="tab-list" class="h-full px-2 hover:text-slate-900 transition-colors text-slate-800">Projetos</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 mt-4 main-content">
        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="block no-print text-slate-800 text-slate-800">
            <div class="mb-10 flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div>
                    <h1 class="text-4xl font-black tracking-tighter uppercase leading-none">Estrat√©gia & Opera√ß√£o</h1>
                    <p class="text-slate-400 text-xs font-bold uppercase mt-2 tracking-widest text-slate-400">Vis√£o macro de efici√™ncia corporativa</p>
                </div>
                <div class="flex flex-wrap gap-2 text-slate-800">
                    <select id="dash-filter-period" class="input-premium !py-2 !text-xs shadow-sm" onchange="window.refreshUI()">
                        <option value="all">Todo o Per√≠odo</option><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="semestre">Semestral</option><option value="ano">Anual</option>
                    </select>
                    <select id="dash-filter-area" class="input-premium !py-2 !text-xs shadow-sm" onchange="window.refreshUI()">
                        <option value="">Todas as √Åreas Impactadas</option>
                    </select>
                </div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-3 mb-12 text-center md:text-left text-slate-800">
                <div class="kpi-card border-l-4 border-slate-900"><p class="label-forte !text-[9px]">Total Projetos</p><h2 id="kpi-total" class="text-2xl font-black">0</h2></div>
                <div class="kpi-card border-l-4 border-cyan-400"><p class="label-forte !text-[9px] text-cyan-600">SLA Geral</p><h2 id="kpi-sla" class="text-2xl font-black text-cyan-600">0%</h2></div>
                <div class="kpi-card border-l-4 border-green-500"><p class="label-forte !text-[9px] text-green-600">No Prazo</p><h2 id="kpi-concluidos-prazo" class="text-2xl font-black text-green-600">0</h2></div>
                <div class="kpi-card border-l-4 border-red-500"><p class="label-forte !text-[9px] text-red-600">Com Atraso</p><h2 id="kpi-concluidos-atraso" class="text-2xl font-black text-red-600">0</h2></div>
                <div class="kpi-card border-l-4 border-amber-400"><p class="label-forte !text-[9px] text-amber-500">Bloqueios</p><h2 id="kpi-blockers" class="text-2xl font-black text-amber-600">0</h2></div>
                <div class="kpi-card border-l-4 border-pink-500"><p class="label-forte !text-[9px] text-pink-600">Prioridade Alta</p><h2 id="kpi-prioridade" class="text-2xl font-black text-pink-600">0</h2></div>
                <div class="kpi-card border-l-4 border-indigo-500"><p class="label-forte !text-[9px] text-indigo-600">Sa√∫de</p><h2 id="kpi-saude" class="text-2xl font-black text-indigo-600">0%</h2></div>
            </div>

            <!-- Gr√°ficos -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-12 text-slate-800">
                <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-6 text-slate-800">Status das Iniciativas</span><div class="w-full h-56 mt-4 text-slate-800 text-slate-800"><canvas id="chartStatus"></canvas></div></div>
                <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-6 text-center text-slate-800">Esfor√ßo por √Årea</span><div class="w-full h-56 mt-4 text-slate-800 text-slate-800"><canvas id="chartTime"></canvas></div></div>
                <div class="bg-white p-8 rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-6 text-center text-slate-800">Pilar Estrat√©gico</span><div class="w-full h-56 mt-4 text-slate-800 text-slate-800"><canvas id="chartFrente"></canvas></div></div>
            </div>

            <div class="mb-12"><div class="bg-white p-10 rounded-[2.5rem] border border-slate-100 shadow-sm text-slate-800"><span class="label-forte mb-8 text-slate-800">Capacidade por L√≠der</span><div class="w-full h-80 text-slate-800 text-slate-800"><canvas id="chartCapacidade"></canvas></div></div></div>
            
            <!-- GRID DE PROJETOS ATIVOS NO DASHBOARD -->
            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 text-slate-800"></div>
        </div>

        <!-- FORMUL√ÅRIO -->
        <div id="view-form" class="hidden max-w-5xl mx-auto text-slate-800">
            <div class="bg-white p-10 rounded-[2.5rem] shadow-2xl border-t-[12px] border-cyan-400 print-card mb-12">
                <div class="flex justify-between items-start mb-10">
                    <div><h2 id="form-title" class="text-3xl font-black uppercase tracking-tighter text-slate-800 text-slate-800">Ficha T√©cnica</h2><p class="text-slate-400 text-sm font-medium text-slate-400">Dados da iniciativa</p></div>
                    <button id="btn-print-project" onclick="window.print()" class="no-print hidden bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-3 text-white shadow-lg"><span class="text-xs uppercase tracking-widest font-black">Exportar</span></button>
                </div>
                
                <form id="project-form" class="space-y-10 text-slate-800">
                    <input type="hidden" id="edit-id" value=""><input type="hidden" id="project-status-internal" value="Backlog">
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-slate-800">
                        <div class="md:col-span-2 text-slate-800"><label class="label-forte" for="iniciativa">Iniciativa / Projeto</label><input type="text" id="iniciativa" required class="w-full input-premium text-lg uppercase text-slate-800" placeholder="EX: PROJETO DE EFICI√äNCIA"></div>
                        <div><label class="label-forte" for="prioridade">Prioridade</label><select id="prioridade" class="w-full input-premium font-bold"><option value="Baixa">Baixa</option><option value="M√©dia">M√©dia</option><option value="Alta">Alta</option></select></div>
                        <div>
                            <div class="flex items-center gap-2 mb-1"><label class="label-forte !mb-0" for="esforco">Tamanho do Esfor√ßo</label></div>
                            <select id="esforco" required class="w-full input-premium font-bold text-slate-800"><option value="R√°pido">R√°pido</option><option value="Intermedi√°rio">Intermedi√°rio</option><option value="Estruturante">Estruturante</option></select>
                        </div>
                        <div><div class="flex justify-between items-center mb-1 text-slate-800"><label class="label-forte !mb-0">√Årea Impactada</label><button type="button" onclick="window.openAdderModal('area')" class="btn-icon-add">+</button></div><select id="time" required class="w-full input-premium"></select></div>
                        <div><div class="flex justify-between items-center mb-1 text-slate-800"><label class="label-forte !mb-0">Frente Trabalho</label><button type="button" onclick="window.openAdderModal('frente')" class="btn-icon-add">+</button></div><select id="frente" class="w-full input-premium"></select></div>
                        <div><label class="label-forte">Status Atual</label><select id="status" class="w-full input-premium font-black text-slate-900" onchange="window.updateInternalStatus(this.value)"><option value="Backlog">Backlog</option><option value="Em Andamento">Em Andamento</option><option value="Finalizado">Finalizado</option><option value="Despriorizado">Despriorizado</option></select></div>
                        
                        <div class="md:col-span-2 bg-slate-50 p-6 rounded-3xl border border-slate-200 shadow-sm text-slate-800 text-slate-800">
                             <label class="label-forte mb-6 text-slate-500">Cronograma</label>
                             <div class="grid grid-cols-2 gap-6 text-slate-800 text-slate-800">
                                <div><label class="label-forte !text-slate-800">Data In√≠cio</label><input type="date" id="data_criacao" required class="w-full input-premium text-sm font-bold border-slate-300 text-slate-800"></div>
                                <div><label class="label-forte !text-slate-800">Prazo Target</label><input type="date" id="prazo" required class="w-full input-premium text-sm font-bold border-slate-300 text-slate-800"></div>
                             </div>
                             <div id="closure-dates" class="mt-8 pt-6 border-t border-slate-200 hidden text-slate-800">
                                <div id="container-conclusao" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
                                    <div><label class="label-forte !text-green-600">Data Real <span class="text-red-500">*</span></label><input type="date" id="data_conclusao" class="w-full input-premium text-sm font-bold border-green-300"></div>
                                    <div><label class="label-forte !text-green-600">Observa√ß√µes</label><textarea id="comentario_conclusao" class="w-full input-premium text-xs h-11 border-green-200 shadow-sm" placeholder="Opcional..."></textarea></div>
                                </div>
                                <div id="container-cancelamento" class="grid grid-cols-1 md:grid-cols-2 gap-6 hidden text-slate-800 text-slate-800">
                                    <div><label class="label-forte !text-red-600">Data <span class="text-red-500">*</span></label><input type="date" id="data_cancelamento" class="w-full input-premium text-sm font-bold border-red-300"></div>
                                    <div><label class="label-forte !text-red-600">Motivo <span class="text-red-500">*</span></label><textarea id="comentario_cancelamento" class="w-full input-premium text-xs h-11 border-red-200 shadow-sm" placeholder="Obrigat√≥rio..."></textarea></div>
                                </div>
                             </div>
                        </div>

                        <div class="md:col-span-2 text-slate-800"><label class="label-forte text-cyan-600">KPIs de Expectativa</label><div class="bg-white p-6 rounded-3xl border-2 border-slate-200 shadow-sm"><div id="metricas-container" class="space-y-3 mb-4 text-slate-800"></div><button type="button" onclick="window.addMetricaInput()" class="text-[10px] font-black text-cyan-500 uppercase tracking-widest">+ Adicionar M√©trica</button></div></div>
                        <div class="md:col-span-4 bg-white p-6 rounded-3xl border-2 border-slate-900 shadow-sm text-slate-800 text-slate-800 text-slate-800"><div class="flex justify-between items-center mb-4 text-slate-800 text-slate-800"><label class="label-forte !mb-0 text-slate-800">Equipe Respons√°vel</label><button type="button" onclick="window.openAdderModal('team')" class="btn-icon-add">+</button></div><div id="responsaveis-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto pr-2 text-slate-800 text-slate-800"></div></div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10 text-slate-800">
                        <div class="space-y-8">
                            <div><label class="label-forte">Descri√ß√£o e Objetivo</label><textarea id="nota_inicial" rows="5" class="w-full input-premium text-sm leading-relaxed text-slate-800" placeholder="Prop√≥sito estrat√©gico..."></textarea></div>
                            <div class="bg-slate-50 p-6 rounded-3xl border border-slate-200 shadow-sm text-slate-800">
                                <div class="flex justify-between items-center mb-4 text-slate-800"><label class="label-forte !mb-0 !text-slate-600">Plano de Atividades</label><span id="task-counter" class="text-[9px] font-black bg-white px-2 py-1 rounded-md border border-slate-200">0 TASKS</span></div>
                                <div class="flex gap-2 mb-4 no-print text-slate-800"><input type="text" id="task-input" placeholder="O que precisa ser feito?" class="flex-1 input-premium !py-2 !text-sm text-slate-800"><button type="button" onclick="window.addTaskToList()" class="bg-slate-900 text-white px-4 rounded-xl font-bold shadow-md text-white text-white">+</button></div>
                                <div id="tasks-container" class="space-y-2 max-h-60 overflow-y-auto pr-1 text-slate-800"></div>
                            </div>
                        </div>
                        <div class="space-y-8 text-slate-800">
                            <div><label class="label-forte text-red-500">üö´ Impedimentos</label><textarea id="impedimentos" rows="3" class="w-full input-premium !bg-red-50/30 !border-red-100 text-sm text-slate-800" placeholder="Algo travando?"></textarea></div>
                            <div id="notes-section" class="hidden text-slate-800">
                                <label class="label-forte">Hist√≥rico de Evolu√ß√£o</label>
                                <div id="notes-history-list" class="space-y-3 mb-4 max-h-56 overflow-y-auto pr-2 text-slate-800 text-slate-800"></div>
                                <div class="bg-cyan-50/40 p-5 rounded-2xl border border-cyan-100 no-print text-slate-800">
                                    <label class="label-forte !text-cyan-600">Nova Nota de Atualiza√ß√£o</label>
                                    <textarea id="new-milestone-note" rows="2" class="w-full input-premium !border-cyan-200 !text-sm text-slate-800"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="status-actions" class="pt-10 flex flex-wrap gap-4 border-t border-slate-100 no-print text-slate-800">
                        <button type="submit" id="btn-submit" class="bg-slate-900 text-white px-10 py-5 rounded-2xl font-black transition flex-1 uppercase tracking-widest text-xs text-white shadow-xl">Salvar Altera√ß√µes</button>
                        <button type="button" id="btn-report" onclick="window.generateProjectReport()" class="hidden bg-cyan-500 text-white px-10 py-5 rounded-2xl font-black uppercase text-white shadow-lg text-xs text-white">Gerar Report</button>
                        <button type="button" id="btn-finish" onclick="window.prepareStatusChange('Finalizado')" class="hidden bg-green-500 text-white px-10 py-5 rounded-2xl font-black uppercase text-white shadow-lg text-xs text-white">Finalizar Projeto</button>
                        <button type="button" id="btn-cancel" onclick="window.prepareStatusChange('Despriorizado')" class="hidden bg-red-500 text-white px-10 py-5 rounded-2xl font-black uppercase text-white shadow-lg text-xs text-white text-white">Despriorizar</button>
                        <button type="button" id="btn-delete-form" onclick="window.openDeleteModalFromForm()" class="hidden bg-red-50 text-red-600 px-10 py-5 rounded-2xl font-black hover:bg-red-100 transition uppercase text-xs text-red-600">Excluir</button>
                        <button type="button" onclick="window.resetForm(); window.switchTab('dashboard');" class="bg-white text-slate-400 border border-slate-200 px-8 py-5 rounded-2xl font-bold transition text-xs uppercase text-slate-800 shadow-sm text-slate-400">Voltar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- LISTA VIEW -->
        <div id="view-list" class="hidden no-print text-slate-800 text-slate-800">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6 text-slate-800">
                <div><h1 class="text-4xl font-black uppercase tracking-tighter leading-none text-slate-800 text-slate-800">Controle de Projetos</h1><p class="text-slate-400 text-xs font-black uppercase tracking-widest mt-2 text-slate-400 text-slate-400">Vis√£o detalhada do cronograma</p></div>
                <div class="flex flex-wrap gap-2 text-slate-800">
                    <select id="list-filter-area" class="input-premium !py-2 !text-[10px]" onchange="window.refreshUI()"><option value="">√Årea</option></select>
                    <select id="list-filter-frente" class="input-premium !py-2 !text-[10px]" onchange="window.refreshUI()"><option value="">Frente</option></select>
                    <select id="list-filter-status" class="input-premium !py-2 !text-[10px]" onchange="refreshUI()"><option value="">Status</option></select>
                    <select id="list-filter-leader" class="input-premium !py-2 !text-[10px]" onchange="refreshUI()"><option value="">L√≠der</option></select>
                    <button onclick="window.clearListFilters()" class="text-[9px] font-black text-slate-300 hover:text-red-500 uppercase px-2 transition text-slate-800">Limpar</button>
                </div>
            </div>
            <div class="bg-white rounded-[2rem] shadow-sm border border-slate-100 overflow-hidden text-slate-800 text-slate-800">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-100 text-slate-400 uppercase text-[9px] font-black tracking-widest text-slate-400 text-slate-400">
                        <tr><th class="p-6 text-center">Prio</th><th class="p-6">Iniciativa</th><th class="p-6 text-center">In√≠cio</th><th class="p-6 text-center">Target</th><th class="p-6 text-center">Dias</th><th class="p-6">Respons√°veis</th><th class="p-6 text-center">Status</th><th class="p-6 text-right">A√ß√µes</th></tr>
                    </thead>
                    <tbody id="detailed-table-body" class="divide-y divide-slate-50 text-slate-800"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAU8nHiRzTwOkrfd8LY7N-YkJG_S7CE0Xs",
            authDomain: "painel-de-projeto.firebaseapp.com",
            projectId: "painel-de-projeto",
            storageBucket: "painel-de-projeto.firebasestorage.app",
            messagingSenderId: "768185401154",
            appId: "1:768185401154:web:d89782c16620a1bf2852db"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-eficiencia-2026';
        
        let projects = [];
        let dynamicTeam = [];
        let dynamicAreas = [];
        let dynamicFrentes = [];
        let charts = {};
        let currentUser = null;
        let currentTasks = [];
        let projectToDeleteId = null;

        const defaultTeam = ["Cauan Pereira Da Silva", "Diego Francisco Rocha", "Hudson Nestor Pereira Cortes", "Lucas Henrique Jantsch", "Luiz Gustavo Ribeiro", "Michael Gabriel Moraes Faria", "Ot√°vio Augusto Oliveira", "Rodrigo Prinz De Paiva", "Simone Thom√© de Andrade"];
        const defaultAreas = ["An√°lise", "CX", "Mesa", "Onboarding", "Comunica√ß√£o"];

        // --- FUN√á√ïES GLOBAIS (DEFINIDAS PRIMEIRO) ---

        window.safeSetText = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text; };
        window.safeSetValue = (id, val) => { const el = document.getElementById(id); if(el) el.value = val; };
        window.formatDate = (d) => d ? d.split('-').reverse().join('/') : '---';

        window.updateDropdown = (elementId, dynamicList, defaults, firstOptionText) => {
            const select = document.getElementById(elementId);
            if(!select) return;
            const currentVal = select.value;
            const fullList = Array.from(new Set([...defaults, ...dynamicList])).sort();
            select.innerHTML = firstOptionText ? `<option value="">${firstOptionText}</option>` : '<option value="" disabled selected>Selecionar...</option>';
            fullList.forEach(item => { select.innerHTML += `<option value="${item}">${item}</option>`; });
            if (currentVal && fullList.includes(currentVal)) select.value = currentVal;
        };

        window.updateLeaderFilters = () => {
            const select = document.getElementById('list-filter-leader');
            if(!select) return;
            const currentVal = select.value;
            const fullTeam = Array.from(new Set([...defaultTeam, ...dynamicTeam])).sort();
            select.innerHTML = '<option value="">L√≠der</option>';
            fullTeam.forEach(name => { select.innerHTML += `<option value="${name}">${name}</option>`; });
            if (currentVal) select.value = currentVal;
        };

        window.updateKPIs = (data) => {
            if(!document.getElementById('kpi-total')) return;
            const finished = data.filter(p => p.status === 'Finalizado');
            const onTime = finished.filter(p => p.data_conclusao && p.prazo && new Date(p.data_conclusao) <= new Date(p.prazo));
            
            window.safeSetText('kpi-total', data.length);
            window.safeSetText('kpi-sla', (finished.length ? Math.round((onTime.length/finished.length)*100) : 0) + '%');
            window.safeSetText('kpi-concluidos-prazo', onTime.length);
            window.safeSetText('kpi-concluidos-atraso', finished.length - onTime.length);
            window.safeSetText('kpi-blockers', data.filter(p => p.impedimentos?.trim()).length);
            window.safeSetText('kpi-prioridade', data.filter(p => p.prioridade === 'Alta').length);
            const saude = data.length ? Math.round(((data.length - data.filter(p => p.impedimentos?.trim()).length)/data.length)*100) : 100;
            window.safeSetText('kpi-saude', saude + '%');
        };

        window.renderTasksList = () => {
            const container = document.getElementById('tasks-container');
            const counter = document.getElementById('task-counter');
            if(!container) return; 
            container.innerHTML = '';
            if(counter) counter.innerText = `${currentTasks.length} TASKS`;
            if(currentTasks.length === 0) { container.innerHTML = '<p class="text-[11px] text-slate-400 italic text-center py-4">Sem tarefas definidas.</p>'; return; }
            currentTasks.forEach(task => {
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 p-3 bg-white border border-slate-100 rounded-xl mb-2 text-slate-800 shadow-sm";
                div.innerHTML = `<input type="checkbox" ${task.completed ? 'checked' : ''} onchange="window.toggleTask(${task.id})" class="w-4 h-4 rounded border-slate-300 text-cyan-500"><span class="flex-1 text-[13px] font-bold ${task.completed ? 'line-through text-slate-300' : ''} text-slate-700">${task.text}</span><button type="button" onclick="window.removeTask(${task.id})" class="text-red-300 hover:text-red-500 px-2 font-black text-xl">√ó</button>`;
                container.appendChild(div);
            });
        };

        window.renderDashboard = (data) => {
            const grid = document.getElementById('projects-grid'); if(!grid) return; grid.innerHTML = '';
            // Mostrar APENAS projetos ATIVOS (Backlog e Em Andamento)
            const actives = data.filter(p => p.status !== 'Finalizado' && p.status !== 'Despriorizado');
            actives.forEach((p) => {
                const slug = p.status?.toLowerCase().replace(/\s/g, '') || 'backlog';
                let metrics = "";
                if(p.metricas?.length) {
                    metrics = `<div class="bg-slate-50 p-3 rounded-xl mt-3 border border-slate-100"><p class="text-[8px] font-black uppercase text-slate-400 mb-2">Indicadores</p>`;
                    p.metricas.forEach(m => {
                        const icon = m.type === 'Ganho' ? '<span class="text-green-500">‚Üë</span>' : '<span class="text-blue-500">‚Üì</span>';
                        metrics += `<div class="flex justify-between items-center text-[10px] mb-1"><span>${icon} ${m.label}</span><span class='font-bold'>üéØ${m.meta} | ‚úÖ${m.real||'-'}</span></div>`;
                    });
                    metrics += `</div>`;
                }
                grid.innerHTML += `<div class="card-project p-8 flex flex-col h-full border-t-[12px] text-slate-800 shadow-sm" style="border-top-color: ${p.time === 'An√°lise' ? '#00e5ff' : '#000a28'}"><div class="flex justify-between items-start mb-6 text-slate-800"><span class="text-[9px] font-black text-slate-300 uppercase tracking-widest">${p.time} | ${p.frente}</span><div class="flex items-center"><span class="status-pill status-${slug}">${p.status}</span></div></div><h3 class="text-xl font-black mb-4 uppercase line-clamp-2 leading-tight text-slate-800">${p.iniciativa}</h3><div class="text-[11px] font-bold space-y-2 mb-6 border-l-2 border-slate-50 pl-4 text-slate-500"><p class="flex justify-between"><span>TARGET:</span> <span class="text-slate-900 font-black">${window.formatDate(p.prazo)}</span></p>${metrics}</div><div class="bg-slate-50 p-4 rounded-2xl flex-grow mb-6 shadow-inner text-[11px] text-slate-600 italic">"${p.notes?.length ? p.notes[p.notes.length-1].text : 'Iniciada.'}"</div><button onclick="window.editProjectByID('${p.id}')" class="bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest shadow-lg hover:bg-slate-800 transition">Ver Detalhes</button></div>`;
            });
        };

        window.renderDetailedList = (data) => {
            const tbody = document.getElementById('detailed-table-body'); if(!tbody) return; tbody.innerHTML = '';
            const today = new Date(); today.setHours(0,0,0,0);
            data.forEach(p => {
                let diffText = "-", diffColor = "text-slate-400";
                if(p.status === 'Finalizado') { diffText = "Conclu√≠do"; diffColor = "text-green-500 font-black"; }
                else if(p.prazo) {
                    const diff = Math.ceil((new Date(p.prazo) - today)/(1000*60*60*24));
                    diffText = diff > 0 ? diff+" d" : (diff === 0 ? "Hoje" : "Atrasado ("+Math.abs(diff)+" d)");
                    diffColor = diff < 0 ? "text-red-500 font-black" : (diff <= 5 ? "text-amber-500 font-black" : "text-slate-600 font-bold text-slate-800");
                }
                const resps = Array.isArray(p.responsavel) ? p.responsavel.slice(0,2).join(', ') : "";
                tbody.innerHTML += `<tr class="hover:bg-slate-50 transition text-slate-800"><td class="p-6 font-black text-[10px] uppercase text-slate-400 text-center">${p.prioridade}</td><td class="p-6 font-black uppercase text-sm">${p.iniciativa}</td><td class="p-6 text-[11px] text-center">${window.formatDate(p.data_criacao)}</td><td class="p-6 text-[11px] font-black text-center">${window.formatDate(p.prazo)}</td><td class="p-6 text-[11px] ${diffColor} text-center">${diffText}</td><td class="p-6 text-xs text-slate-700">${resps}</td><td class="p-6 text-center"><span class="status-pill bg-slate-100 font-black">${p.status}</span></td><td class="p-6 text-right space-x-3 text-slate-800"><button onclick="window.editProjectByID('${p.id}')" class="text-cyan-500 font-black text-[10px] uppercase hover:underline">Editar</button><button onclick="window.openDeleteModal('${p.id}')" class="text-red-300 hover:text-red-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button></td></tr>`;
            });
        };

        window.refreshUI = () => {
            const tab = document.querySelector('.active-tab')?.id.split('-')[1] || 'dashboard';
            const area = document.getElementById(tab === 'dashboard' ? 'dash-filter-area' : 'list-filter-area')?.value || "";
            const period = document.getElementById('dash-filter-period')?.value || 'all';
            let filtered = projects.filter(p => (!area || p.time === area));
            if(tab === 'dashboard') {
                const periodFiltered = filtered.filter(p => isProjectInPeriod(p.data_criacao, period));
                window.updateKPIs(periodFiltered); 
                window.renderDashboard(periodFiltered); // Mostra apenas ativos
                window.updateCharts(periodFiltered); 
                window.renderCapacidadeChart(periodFiltered);
            } else if (tab === 'list') {
                const fr = document.getElementById('list-filter-frente')?.value || "";
                const st = document.getElementById('list-filter-status')?.value || "";
                const ld = document.getElementById('list-filter-leader')?.value || "";
                filtered = filtered.filter(p => (!fr || p.frente === fr) && (!st || p.status === st) && (!ld || (Array.isArray(p.responsavel) && p.responsavel.includes(ld))));
                window.renderDetailedList(filtered);
            }
        };

        window.setupRealtimeListeners = () => {
            if (!currentUser) return;
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'team'), snap => { dynamicTeam = snap.docs.map(doc => doc.data().name); window.renderTeamCheckboxes(); window.updateLeaderFilters(); window.refreshUI(); }, err => console.error(err));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'areas'), snap => { dynamicAreas = snap.docs.map(doc => doc.data().name); window.updateDropdown('time', dynamicAreas, defaultAreas); window.updateDropdown('dash-filter-area', dynamicAreas, defaultAreas, "Todas as √Åreas Impactadas"); window.updateDropdown('list-filter-area', dynamicAreas, defaultAreas, "√Årea"); }, err => console.error(err));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'frentes'), snap => { dynamicFrentes = snap.docs.map(doc => doc.data().name); const defFrentes = ["Performance", "Reestrutura√ß√£o", "Automa√ß√£o", "Simplifica√ß√£o"]; window.updateDropdown('frente', dynamicFrentes, defFrentes); window.updateDropdown('list-filter-frente', dynamicFrentes, defFrentes, "Frente"); }, err => console.error(err));
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), snap => { projects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); projects.sort((a,b) => (a.data_criacao || "") > (b.data_criacao || "") ? 1 : -1); const overlay = document.getElementById('loading-overlay'); if(overlay) { overlay.style.opacity = '0'; setTimeout(() => overlay.style.display = 'none', 500); } window.refreshUI(); }, err => console.error(err));
        };

        // --- HANDLERS ---
        window.switchTab = (t) => { 
            ['view-dashboard', 'view-form', 'view-list'].forEach(v => document.getElementById(v)?.classList.add('hidden')); 
            const target = document.getElementById('view-'+t); if(target) target.classList.remove('hidden'); 
            ['tab-dashboard', 'tab-form', 'tab-list'].forEach(btn => document.getElementById(btn)?.classList.toggle('active-tab', btn==='tab-'+t)); 
            if (t !== 'form') { window.safeSetValue('edit-id', ""); } window.refreshUI(); 
        };

        window.openDeleteModal = (id) => { projectToDeleteId = id; const m = document.getElementById('delete-modal'); if(m) { m.classList.remove('hidden'); m.classList.add('flex'); } };
        window.closeDeleteModal = () => { projectToDeleteId = null; document.getElementById('delete-modal')?.classList.add('hidden'); };
        window.openDeleteModalFromForm = () => { const id = document.getElementById('edit-id')?.value; if(id) window.openDeleteModal(id); };
        document.getElementById('confirm-delete-btn').onclick = async () => { if(projectToDeleteId) { try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', projectToDeleteId)); window.closeDeleteModal(); window.switchTab('dashboard'); } catch(e) { console.error(e); } } };

        window.addTaskToList = () => { const inp = document.getElementById('task-input'); if (!inp || !inp.value.trim()) return; currentTasks.push({ id: Date.now(), text: inp.value.trim(), completed: false }); inp.value = ""; window.renderTasksList(); };
        window.toggleTask = (id) => { currentTasks = currentTasks.map(t => t.id === id ? { ...t, completed: !t.completed } : t); window.renderTasksList(); };
        window.removeTask = (id) => { currentTasks = currentTasks.filter(t => t.id !== id); window.renderTasksList(); };

        window.addMetricaInput = (l = '', m = '', r = '', t = 'Ganho') => {
            const container = document.getElementById('metricas-container'); if(!container) return;
            const div = document.createElement('div'); div.className = 'metrica-row mb-4';
            div.innerHTML = `
                <div><label class="label-forte !text-[9px]">KPI</label><input type="text" class="metrica-label input-premium !py-1.5 !text-[10px] w-full uppercase text-slate-800" value="${l}"></div>
                <div><label class="label-forte !text-[9px]">Meta</label><input type="text" class="metrica-meta input-premium !py-1.5 !text-[10px] w-full text-slate-800" value="${m}"></div>
                <div><label class="label-forte !text-[9px]">Real</label><input type="text" class="metrica-real input-premium !py-1.5 !text-[10px] w-full text-slate-800" value="${r}"></div>
                <div><label class="label-forte !text-[9px]">Tipo</label><select class="metrica-type input-premium !py-1.5 !text-[10px] w-full text-slate-800"><option value="Ganho" ${t==='Ganho'?'selected':''}>Ganho (+)</option><option value="Redu√ß√£o" ${t==='Redu√ß√£o'?'selected':''}>Redu√ß√£o (-)</option></select></div>
                <button type="button" onclick="this.parentElement.remove()" class="text-red-300 hover:text-red-500 pb-2 font-black text-xl">√ó</button>`;
            container.appendChild(div);
        };

        window.editProjectByID = (id) => { 
            const p = projects.find(x => x.id === id); 
            if(p) {
                window.safeSetValue('edit-id', p.id); window.safeSetValue('iniciativa', p.iniciativa || ""); window.safeSetValue('prioridade', p.prioridade || "Baixa");
                window.safeSetValue('esforco', p.esforco || 'R√°pido'); window.safeSetValue('time', p.time || ""); window.safeSetValue('frente', p.frente || ""); window.safeSetValue('status', p.status || "Backlog");
                window.safeSetValue('data_criacao', p.data_criacao || ""); window.safeSetValue('prazo', p.prazo || ""); window.safeSetValue('data_conclusao', p.data_conclusao || "");
                window.safeSetValue('comentario_conclusao', p.comentario_conclusao || ""); window.safeSetValue('data_cancelamento', p.data_cancelamento || ""); window.safeSetValue('comentario_cancelamento', p.comentario_cancelamento || "");
                window.safeSetValue('impedimentos', p.impedimentos || ""); window.safeSetValue('nota_inicial', p.nota_inicial || "");
                
                window.toggleConclusionField(p.status);
                ['btn-finish', 'btn-cancel', 'btn-report', 'btn-print-project', 'btn-delete-form', 'notes-section'].forEach(id => document.getElementById(id)?.classList.remove('hidden'));
                currentTasks = Array.isArray(p.atividades) ? [...p.atividades] : []; window.renderTasksList();
                const mC = document.getElementById('metricas-container'); if(mC) mC.innerHTML = '';
                if(p.metricas?.length) p.metricas.forEach(m => window.addMetricaInput(m.label, m.meta, m.real, m.type)); else window.addMetricaInput();
                document.querySelectorAll('input[name="responsavel_check"]').forEach(cb => cb.checked = Array.isArray(p.responsavel) && p.responsavel.includes(cb.value));
                const hist = document.getElementById('notes-history-list'); if(hist) { hist.innerHTML = ''; [...(p.notes || [])].reverse().forEach(n => { hist.innerHTML += `<div class="p-4 bg-slate-50 rounded-2xl mb-2 border border-slate-100 shadow-sm text-slate-700 text-[11px] font-bold text-slate-800"><span class="text-[8px] font-black text-cyan-500 uppercase">${n.date}</span><p class="mt-1">${n.text}</p></div>`; }); }
                window.switchTab('form');
            }
        };

        window.resetForm = () => { 
            document.getElementById('project-form')?.reset(); window.safeSetValue('edit-id', ""); window.safeSetValue('status', "Backlog");
            ['notes-section', 'closure-dates', 'btn-finish', 'btn-cancel', 'btn-report', 'btn-delete-form', 'btn-print-project'].forEach(id => document.getElementById(id)?.classList.add('hidden'));
            const mC = document.getElementById('metricas-container'); if(mC) mC.innerHTML = ''; window.addMetricaInput();
            currentTasks = []; window.renderTasksList();
            const today = new Date().toISOString().split('T')[0]; window.safeSetValue('data_criacao', today); window.safeSetValue('prazo', today);
        };

        window.updateInternalStatus = (v) => { window.toggleConclusionField(v); };
        window.toggleConclusionField = (s) => { const sec = document.getElementById('closure-dates'); if(sec) sec.classList.toggle('hidden', s !== 'Finalizado' && s !== 'Despriorizado'); document.getElementById('container-conclusao')?.classList.toggle('hidden', s !== 'Finalizado'); document.getElementById('container-cancelamento')?.classList.toggle('hidden', s !== 'Despriorizado'); };
        window.renderChart = (id, type, data, colors) => { if(charts[id]) charts[id].destroy(); const canvas = document.getElementById(id); if(!canvas) return; charts[id] = new Chart(canvas.getContext('2d'), { type: type, data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colors, borderWidth: 0, borderRadius: 12 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'pie', position: 'bottom' } } } }); };
        window.renderTeamCheckboxes = () => { const container = document.getElementById('responsaveis-grid'); if(!container) return; const fullList = Array.from(new Set([...defaultTeam, ...dynamicTeam])).sort(); container.innerHTML = ''; fullList.forEach(name => { container.innerHTML += `<label class="checkbox-item text-xs font-bold text-slate-600 text-slate-800"><input type="checkbox" name="responsavel_check" value="${name}" class="w-4 h-4 rounded border-slate-300 accent-cyan-500"><span>${name}</span></label>`; }); };
        window.clearListFilters = () => { ['list-filter-area', 'list-filter-frente', 'list-filter-status', 'list-filter-leader'].forEach(id => window.safeSetValue(id, "")); window.refreshUI(); };

        window.initAuth = async () => { try { await signInAnonymously(auth); } catch (e) { console.error("Auth", e); } };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('sync-indicator')?.classList.remove('hidden');
                window.setupRealtimeListeners();
            } else { window.initAuth(); }
        });

        window.initAuth();
    </script>
</body>
</html>
