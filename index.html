<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Efici√™ncia Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Nunito+Sans:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --success-color: #10b981;
            --bg-body: #f8fafc;
            --color-backlog: #94a3b8;
            --color-andamento: #fabd23;
            --color-finalizado: #10b981;
            --color-despriorizado: #ef4444;
            --u-azul: #00A5FF;
            --u-rosa: #FF1A5C;
            --u-purpura: #A35F9D;
            --u-roxo: #8D7AD2;
            --u-verde: #32B77E;
            --u-azul-pay: #5C86C4;
            --u-azul-escuro: #070047;
            --u-cinza: #333333;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
            -webkit-font-smoothing: antialiased;
        }
        .input-premium {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.65rem 1rem;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            font-weight: 600;
            font-size: 0.85rem;
            width: 100%;
        }
        .input-premium:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.08);
        }
        .label-forte {
            font-size: 0.7rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #64748b;
            margin-bottom: 0.6rem;
            display: block;
        }
        .active-tab {
            color: var(--primary-color);
            border-bottom: 3px solid var(--accent-color);
            font-weight: 900;
        }
        .kpi-card {
            background: white;
            padding: 1.5rem 1rem;
            border-radius: 1.5rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;            justify-content: center;
            text-align: center;
            gap: 0.4rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.02);
        }
        .form-section-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.02);
        }
        @media (min-width: 768px) { .form-section-box { padding: 2.5rem; } }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 0.85rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: #fff;
            border: 1px solid #f1f5f9;
        }
        .checkbox-item:hover { background: #f8fafc; border-color: #e2e8f0; }
        .checkbox-item input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            position: relative;
            background: white;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        .checkbox-item input[type="checkbox"]:checked {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }
        .checkbox-item input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            color: #000a28;
            font-size: 14px;
            font-weight: 900;
            left: 50%; top: 45%; transform: translate(-50%, -50%);
        }
        .checkbox-item span { font-size: 0.85rem; font-weight: 700; color: #334155; }
        .toggle-btn {
            padding: 8px 16px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 800;
            text-transform: uppercase;
            border: 2px solid transparent;
            transition: all 0.2s;
            cursor: pointer;
        }
        .toggle-btn.active-risco { background: #fef3c7; border-color: #fbbf24; color: #92400e; }
        .toggle-btn.active-problema { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .toggle-btn.inactive { background: #f8fafc; color: #94a3b8; border-color: #e2e8f0; }
        .card-project { background: white; border-radius: 24px; border: 1px solid #e2e8f0; transition: all 0.3s ease; border-top-width: 12px; }
        .status-pill { 
            font-size: 0.6rem; 
            font-weight: 900; 
            padding: 4px 12px; 
            border-radius: 100px; 
            text-transform: uppercase; 
            white-space: nowrap; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            min-width: 110px;
            height: 24px;
        }
        .btn-add-item { display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; background: #f1f5f9; color: #64748b; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.2s; margin-left: 8px; }
        .progress-container { width: 100%; background-color: #e2e8f0; border-radius: 999px; height: 8px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { height: 100%; background-color: var(--success-color); transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .history-entry p { white-space: pre-wrap; word-wrap: break-word; }
        .history-entry { padding: 0.75rem; background-color: #f8fafc; border-radius: 1rem; border: 1px solid #f1f5f9; margin-bottom: 0.5rem; }
        .task-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; background: #fff; border: 1px solid #f1f5f9; border-radius: 10px; margin-bottom: 0.5rem; }
        .task-item input[type="checkbox"] { width: 1.1rem; height: 1.1rem; accent-color: var(--success-color); cursor: pointer; }
        .column-board { background: rgba(226, 232, 240, 0.3); border-radius: 1.5rem; padding: 1.25rem; min-height: 400px; height: fit-content; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 10, 40, 0.5); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 10000; }
        .modal-content { background: white; padding: 2rem; border-radius: 2rem; width: 90%; max-width: 450px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        
        /* Planeamento Espec√≠fico */
        .history-card { 
            background: white; border: 1px solid #e2e8f0; border-radius: 1.5rem; 
            padding: 1.5rem; transition: all 0.2s; cursor: pointer; border-left-width: 8px; 
            position: relative;
        }
        .history-card:hover { transform: translateY(-3px); border-color: var(--accent-color); }
        .history-card.current { border-left-color: var(--accent-color); background: #f0fdff; }
        .metric-row { display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; padding: 6px 0; font-size: 10px; }
        .metric-row:last-child { border-bottom: none; }
        .btn-delete-card {
            position: absolute; top: 12px; right: 12px; padding: 8px;
            border-radius: 10px; color: #cbd5e1; transition: all 0.2s;
        }
        .btn-delete-card:hover { background: #fee2e2; color: #ef4444; }

        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .form-section-box { border: 1px solid #eee; break-inside: avoid; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="loading-overlay" style="position: fixed; inset: 0; background: var(--primary-color); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; color: white; transition: opacity 0.5s;">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-24 md:w-32 mb-8 invert" alt="Unico">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
        <p class="text-[10px] uppercase font-black tracking-widest mt-4 opacity-50">Sincronizando ambiente...</p>
    </div>

    <!-- MODAIS DO SISTEMA PRINCIPAL -->
    <div id="confirm-exit-modal" class="modal-overlay">
        <div class="modal-content text-center text-slate-800">
            <div class="w-16 h-16 bg-amber-50 text-amber-500 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 class="text-xl md:text-2xl font-black mb-2 uppercase tracking-tighter text-slate-800">Altera√ß√µes n√£o salvas</h3>
            <p class="text-slate-500 mb-8 font-medium text-sm">Tens altera√ß√µes pendentes na Ficha T√©cnica. Deseja salvar o progresso antes de sair?</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.saveAndExit()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-slate-800 transition-all">Salvar e Sair</button>
                <button onclick="window.discardAndExit()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px] tracking-widest hover:bg-slate-200 transition-all">Descartar</button>
            </div>
        </div>
    </div>

    <div id="finish-confirm-modal" class="modal-overlay">
        <div class="modal-content text-center text-slate-800">
            <div class="w-16 h-16 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">‚úÖ</div>
            <h3 class="text-xl font-black mb-2 uppercase tracking-tighter">Finalizar Projeto?</h3>
            <p class="text-slate-500 mb-8 text-sm">Deseja concluir esta iniciativa?</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.confirmFinalization()" class="flex-1 bg-emerald-500 text-white py-3.5 rounded-2xl font-black uppercase text-[11px]">Confirmar</button>
                <button onclick="window.closeFinishModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay">
        <div class="modal-content text-center text-slate-800">
            <h3 class="text-xl font-black mb-2 uppercase tracking-tighter">Excluir?</h3>
            <p class="text-slate-500 mb-8 text-sm">A remo√ß√£o ser√° permanente.</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <button onclick="window.confirmDelete()" class="flex-1 bg-red-500 text-white py-3.5 rounded-2xl font-black uppercase text-[11px]">Confirmar</button>
                <button onclick="window.closeDeleteModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="add-item-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="add-item-title" class="text-xl font-black mb-6 uppercase tracking-tighter">Adicionar Op√ß√£o</h3>
            <input type="text" id="new-item-input" class="input-premium mb-8 text-slate-800" placeholder="Digite o nome...">
            <div class="flex gap-3">
                <button onclick="window.processAddItem()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[11px]">Adicionar</button>
                <button onclick="window.closeAddModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[11px]">Sair</button>
            </div>
        </div>
    </div>

    <!-- MODAIS DO PLANEJAMENTO -->
    <div id="config-success-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="w-16 h-16 bg-emerald-50 text-emerald-500 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">‚úÖ</div>
            <h3 class="text-xl font-black uppercase text-slate-800 mb-4 tracking-tighter">Salvo com Sucesso</h3>
            <p class="text-sm text-slate-500 mb-8 font-medium">Os par√¢metros do ciclo foram atualizados.</p>
            <button onclick="document.getElementById('config-success-modal').style.display='none'" class="w-full bg-slate-900 text-white py-3 rounded-2xl font-black uppercase text-[10px]">Fechar</button>
        </div>
    </div>

    <div id="delete-period-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <div class="w-16 h-16 bg-red-50 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6 text-2xl">üóëÔ∏è</div>
            <h3 class="text-xl font-black uppercase tracking-tighter">Excluir Ciclo?</h3>
            <div class="flex gap-3 mt-8">
                <button onclick="window.confirmDeletePeriod()" class="flex-1 bg-red-500 text-white py-3.5 rounded-2xl font-black uppercase text-[10px]">Excluir</button>
                <button onclick="window.hideDeletePeriodModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[10px]">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="add-year-modal" class="modal-overlay">
        <div class="modal-content text-center">
            <h3 class="text-xl font-black uppercase mb-4 tracking-tighter">Novo Ano</h3>
            <input type="number" id="new-year-input-planning" class="input-premium mb-6 text-center text-lg" placeholder="Ex: 2028" min="2024">
            <div class="flex gap-3">
                <button onclick="window.confirmAddYear()" class="flex-1 bg-slate-900 text-white py-3.5 rounded-2xl font-black uppercase text-[10px]">Cadastrar</button>
                <button onclick="window.hideAddYearModal()" class="flex-1 bg-slate-100 text-slate-500 py-3.5 rounded-2xl font-black uppercase text-[10px]">Cancelar</button>
            </div>
        </div>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-4 md:px-8 h-16 md:h-20 flex justify-between items-center">
            <div class="flex items-center gap-4 md:gap-8">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-6" alt="Unico Logo">
                <div id="sync-indicator" class="hidden sm:flex items-center gap-2 px-3 md:px-4 py-1.5 bg-green-50 rounded-full border border-green-100">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[8px] md:text-[10px] font-black text-green-600 uppercase tracking-widest">Tempo Real</span>                </div>
            </div>
            <nav class="flex gap-4 md:gap-10 h-full items-center text-[9px] md:text-[11px] font-bold uppercase tracking-widest text-slate-400">
                <button onclick="window.trySwitchTab('dashboard')" id="tab-dashboard" class="h-full px-1 md:px-2 active-tab transition-all">Dash</button>
                <button onclick="window.trySwitchTab('form')" id="tab-form" class="h-full px-1 md:px-2 hover:text-slate-900 transition-all">Novo</button>
                <button onclick="window.trySwitchTab('list')" id="tab-list" class="h-full px-1 md:px-2 hover:text-slate-900 transition-all">Projetos</button>
                <button onclick="window.trySwitchTab('archive')" id="tab-archive" class="h-full px-1 md:px-2 hover:text-slate-900 transition-all">Arquivo</button>
                <button onclick="window.trySwitchTab('planning')" id="tab-planning" class="h-full px-1 md:px-2 hover:text-slate-900 transition-all">Planejamento</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-4 md:p-8 mt-2 md:mt-4">
        <!-- VIEW DASHBOARD -->
        <div id="view-dashboard" class="block no-print">
            <div class="mb-8 md:mb-12 flex flex-col xl:flex-row xl:items-end justify-between gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Estrat√©gia & Opera√ß√£o</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 md:mt-3 tracking-widest">Painel de Decis√µes e Efici√™ncia</p>
                </div>
                <div class="flex flex-wrap gap-2 md:gap-3 items-center">
                    <input type="text" id="search-dash" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Buscar projeto..." oninput="window.refreshUI()">
                    <select id="dash-filter-period" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="all">Todo o Per√≠odo</option><option value="mes">Mensal</option><option value="trimestre">Trimestral</option><option value="ano">Anual</option>
                    </select>
                    <select id="dash-filter-analista" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="">Analistas (Todos)</option>
                    </select>
                    <select id="dash-filter-area" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="">√Åreas (Todas)</option>
                    </select>
                    <select id="dash-filter-frente" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="">Frentes (Todas)</option>
                    </select>
                    <select id="dash-filter-classificacao" class="input-premium !py-1.5 !px-3 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="">Classifica√ß√£o (Todas)</option>
                        <option value="Efici√™ncia Operacional">Efici√™ncia Operacional</option>
                        <option value="Rotina">Rotina</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 md:gap-6 mb-8 md:mb-12">
                <div class="kpi-card"><p class="label-forte !mb-0 text-[9px] md:text-[11px] text-slate-400">Total</p><h2 id="kpi-total" class="text-2xl md:text-3xl font-black text-slate-900">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-cyan-500 text-[9px] md:text-[11px]">SLA Geral</p><h2 id="kpi-sla" class="text-2xl md:text-3xl font-black text-cyan-500">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-green-500 text-[9px] md:text-[11px]">Ader√™ncia</p><h2 id="kpi-performance" class="text-2xl md:text-3xl font-black text-green-500">0%</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-blue-500 text-[9px] md:text-[11px]">Riscos</p><h2 id="kpi-riscos" class="text-xl md:text-2xl font-black text-blue-500">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-red-500 text-[9px] md:text-[11px]">Problemas</p><h2 id="kpi-problemas" class="text-xl md:text-2xl font-black text-red-500">0</h2></div>
                <div class="kpi-card"><p class="label-forte !mb-0 text-indigo-500 text-[9px] md:text-[11px]">Sa√∫de</p><h2 id="kpi-saude" class="text-2xl md:text-3xl font-black text-indigo-500">100%</h2></div>
            </div>
            <div class="h-px bg-slate-200 w-full mb-8 md:mb-12 opacity-30 shadow-sm"></div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8 mb-8 md:mb-12">
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] md:rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-2 md:mb-4">Status</span><div class="w-full h-40 md:h-44"><canvas id="chartStatus"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] md:rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-2 md:mb-4">√Årea</span><div class="w-full h-40 md:h-44"><canvas id="chartTime"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] md:rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-2 md:mb-4">Frentes Ativas</span><div class="w-full h-40 md:h-44"><canvas id="chartFrente"></canvas></div></div>
                <div class="bg-white p-4 md:p-8 rounded-[1.5rem] md:rounded-[2rem] border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte mb-2 md:mb-4">Lead Time M√©dio</span><div class="w-full h-40 md:h-44"><canvas id="chartLeadTime"></canvas></div></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                <div class="column-board">
                    <label class="label-forte text-slate-400 mb-6 flex justify-between items-center">
                        <span>Backlog</span>
                        <span id="count-backlog" class="bg-[#94a3b8] text-white px-3 py-1 rounded-full text-[10px] font-black">0</span>
                    </label>
                    <div id="grid-backlog" class="space-y-6"></div>
                </div>
                <div class="column-board">
                    <label class="label-forte text-slate-400 mb-6 flex justify-between items-center">
                        <span>Em Andamento</span>
                        <span id="count-andamento" class="bg-[#fef3c7] text-[#92400e] px-3 py-1 rounded-full text-[10px] font-black">0</span>
                    </label>
                    <div id="grid-andamento" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- VIEW LIST -->
        <div id="view-list" class="hidden no-print">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Projetos</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 md:mt-3 tracking-widest">Controle e Listagem Geral</p>
                </div>
                <div class="flex flex-wrap gap-2 md:gap-3">
                    <button onclick="window.exportToXLS()" class="bg-white border border-slate-200 px-5 py-2.5 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-50 shadow-sm">Exportar XLS</button>
                    <button onclick="window.exportPDF()" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-black text-[9px] uppercase tracking-widest hover:bg-slate-800 shadow-sm">Exportar PDF</button>
                    <input type="text" id="search-list" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Buscar projeto..." oninput="window.refreshUI()">
                </div>
            </div>
            <div class="mb-6 flex flex-wrap items-center gap-4 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                <div class="flex flex-col w-full sm:w-auto min-w-[200px]">
                    <label class="label-forte !mb-1 text-[8px]">Analista Respons√°vel</label>
                    <select id="list-filter-analista" class="input-premium !py-2 !px-3 !text-[10px] shadow-sm" onchange="window.refreshUI()"><option value="">Todos Analistas</option></select>
                </div>
                <div class="flex flex-col w-full sm:w-auto min-w-[150px]">
                    <label class="label-forte !mb-1 text-[8px]">Status</label>
                    <select id="list-filter-status" class="input-premium !py-2 !px-3 !text-[10px] shadow-sm" onchange="window.refreshUI()">
                        <option value="">Todos Status</option>
                        <option value="Backlog">Backlog</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Despriorizado">Despriorizado</option>
                    </select>
                </div>
                <div class="flex flex-col w-full sm:w-auto min-w-[150px]">
                    <label class="label-forte !mb-1 text-[8px]">Frente</label>
                    <select id="list-filter-frente" class="input-premium !py-2 !px-3 !text-[10px] shadow-sm" onchange="window.refreshUI()"><option value="">Todas Frentes</option></select>
                </div>
            </div>
            <div class="bg-white rounded-[1.5rem] md:rounded-[2.25rem] border border-slate-100 shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[1000px]">
                        <thead class="bg-slate-50 border-b border-slate-100 text-[10px] font-black uppercase tracking-widest text-slate-400">
                            <tr><th class="p-6 md:p-8">Iniciativa</th><th class="p-6 md:p-8">√Årea</th><th class="p-6 md:p-8 text-center">Respons√°veis</th><th class="p-6 md:p-8 text-center">Estimado</th><th class="p-6 md:p-8 text-center">Status</th><th class="p-6 md:p-8 text-right">A√ß√µes</th></tr>
                        </thead>
                        <tbody id="detailed-table-body" class="divide-y divide-slate-100 text-[11px] md:text-[13px] font-bold text-slate-700"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW ARQUIVO -->
        <div id="view-archive" class="hidden no-print">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                <div>
                    <h1 class="text-2xl md:text-4xl font-black tracking-tighter uppercase leading-none text-slate-900">Arquivo</h1>
                    <p class="text-slate-400 text-[10px] md:text-xs font-bold uppercase mt-2 md:mt-3 tracking-widest">Controle de Projetos Conclu√≠dos</p>
                </div>
                <div class="flex flex-wrap gap-2 md:gap-3">
                    <input type="text" id="search-archive" class="input-premium !py-1.5 !px-3 !text-[10px] !w-40 shadow-sm" placeholder="Pesquisar arquivo..." oninput="window.refreshUI()">
                </div>
            </div>
            <div class="mb-6 flex flex-wrap items-center gap-4 bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                <div class="flex flex-col w-full sm:w-auto min-w-[200px]">
                    <label class="label-forte !mb-1 text-[8px]">Analista Respons√°vel</label>
                    <select id="archive-filter-analista" class="input-premium !py-2 !px-3 !text-[10px] shadow-sm" onchange="window.refreshUI()"><option value="">Todos Analistas</option></select>
                </div>
                <div class="flex flex-col w-full sm:w-auto min-w-[150px]">
                    <label class="label-forte !mb-1 text-[8px]">Frente</label>
                    <select id="archive-filter-frente" class="input-premium !py-2 !px-3 !text-[10px] shadow-sm" onchange="window.refreshUI()"><option value="">Todas Frentes</option></select>
                </div>
                <div class="flex flex-col w-full sm:w-auto min-w-[150px]">
                    <label class="label-forte !mb-1 text-[8px]">√Årea</label>
                    <select id="archive-filter-area" class="input-premium !py-2 !px-3 !text-[10px] shadow-sm" onchange="window.refreshUI()"><option value="">Todas √Åreas</option></select>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="column-board">
                    <label class="label-forte text-emerald-600 mb-6 flex justify-between items-center uppercase">
                        <span>Finalizados</span><span id="count-finalizado-archive" class="count-badge bg-emerald-50 text-emerald-700">0</span>
                    </label>
                    <div id="grid-finalizado" class="space-y-6"></div>
                </div>
                <div class="column-board">
                    <label class="label-forte text-red-600 mb-6 flex justify-between items-center uppercase">
                        <span>Despriorizados</span><span id="count-despriorizado-archive" class="count-badge bg-red-50 text-red-700">0</span>
                    </label>
                    <div id="grid-despriorizado" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- VIEW PLANEJAMENTO (POR √öLTIMO) -->
        <div id="view-planning" class="hidden no-print">
            <div class="text-left mb-8">
                <h1 class="text-3xl font-black uppercase text-slate-900 tracking-tighter">Metas e Baselines</h1>
                <p class="text-slate-400 font-bold text-xs uppercase tracking-widest mt-2">Defini√ß√£o de objetivos por ciclo semestral</p>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <div class="lg:col-span-5">
                    <div class="form-section-box shadow-xl border-indigo-100 !bg-indigo-50/10">
                        <div class="flex justify-between items-center mb-6 pb-2 border-b border-indigo-100">
                            <label class="label-forte text-indigo-600 !mb-0">Ciclo Atual</label>
                            <span class="text-[9px] font-black text-indigo-400 uppercase">Configura√ß√£o</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-8">
                            <div>
                                <label class="label-forte">Semestre</label>
                                <select id="config-half" class="input-premium font-black text-slate-800" onchange="window.handlePeriodChange()">
                                    <option value="H1">H1 (Jan-Jun)</option><option value="H2">H2 (Jul-Dez)</option>
                                </select>
                            </div>
                            <div>
                                <label class="label-forte">Ano</label>
                                <div class="flex gap-2">
                                    <select id="config-year" class="input-premium font-black text-slate-800" onchange="window.handlePeriodChange()">
                                        <option value="2025">2025</option><option value="2026">2026</option><option value="2027">2027</option>
                                    </select>
                                    <button onclick="window.showAddYearModal()" class="bg-white border border-slate-200 px-3 rounded-xl hover:bg-slate-50 transition-all text-slate-400 font-bold">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-6">
                            <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                <label class="label-forte mb-3">Custo por An√°lise (R$)</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><small class="text-[8px] font-black text-slate-400 uppercase block mb-1">Baseline</small><input type="number" id="config-baseline-analysis" step="0.01" class="input-premium" placeholder="0.00"></div>
                                    <div><small class="text-[8px] font-black text-indigo-400 uppercase block mb-1">Meta</small><input type="number" id="config-target-analysis" step="0.01" class="input-premium !border-indigo-100" placeholder="0.00"></div>
                                </div>
                            </div>
                            <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                <label class="label-forte mb-3">Custo por Chamado (R$)</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><small class="text-[8px] font-black text-slate-400 uppercase block mb-1">Baseline</small><input type="number" id="config-baseline-call" step="0.01" class="input-premium" placeholder="0.00"></div>
                                    <div><small class="text-[8px] font-black text-indigo-400 uppercase block mb-1">Meta</small><input type="number" id="config-target-call" step="0.01" class="input-premium !border-indigo-100" placeholder="0.00"></div>
                                </div>
                            </div>
                            <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                <label class="label-forte mb-3">Qualidade (%)</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><small class="text-[8px] font-black text-slate-400 uppercase block mb-1">Baseline</small><input type="number" id="config-baseline-quality" class="input-premium" placeholder="0"></div>
                                    <div><small class="text-[8px] font-black text-indigo-400 uppercase block mb-1">Meta</small><input type="number" id="config-target-quality" class="input-premium !border-indigo-100" placeholder="0"></div>
                                </div>
                            </div>
                            <div class="p-4 bg-white rounded-2xl border border-slate-100 shadow-sm">
                                <label class="label-forte mb-3">SLA (%)</label>
                                <div class="grid grid-cols-2 gap-4">
                                    <div><small class="text-[8px] font-black text-slate-400 uppercase block mb-1">Baseline</small><input type="number" id="config-baseline-sla" class="input-premium" placeholder="0"></div>
                                    <div><small class="text-[8px] font-black text-indigo-400 uppercase block mb-1">Meta</small><input type="number" id="config-target-sla" class="input-premium !border-indigo-100" placeholder="0"></div>
                                </div>
                            </div>
                        </div>
                        <button onclick="window.saveGlobalSettings()" class="w-full mt-10 bg-slate-900 text-white py-5 rounded-2xl font-black uppercase text-[11px] tracking-widest shadow-2xl hover:scale-[1.01] transition-all">Salvar Planejamento</button>
                    </div>
                </div>
                <div class="lg:col-span-7">
                    <div class="flex justify-between items-center mb-6">
                        <label class="label-forte text-slate-400 uppercase !mb-0">Hist√≥rico de Ciclos</label>
                        <span id="history-count" class="text-[10px] font-black bg-slate-100 px-3 py-1 rounded-full">0 Registros</span>
                    </div>
                    <div id="config-history-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                </div>
            </div>
        </div>

        <!-- VIEW FORM -->
        <div id="view-form" class="hidden max-w-6xl mx-auto">
            <div class="mb-6 md:mb-10 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                <h2 id="form-title" class="text-2xl md:text-3xl font-black uppercase tracking-tighter text-slate-900">Ficha T√©cnica</h2>
                <div class="flex gap-2 md:gap-4 no-print w-full sm:w-auto">
                    <button id="btn-concluir-quick" onclick="window.showFinishAction()" class="hidden bg-emerald-500 text-white px-4 md:px-8 py-3 md:py-3.5 rounded-xl md:rounded-2xl font-black text-[9px] md:text-[10px] uppercase tracking-widest shadow-lg shadow-emerald-100 hover:scale-105 transition-all">Finalizar Projeto</button>
                    <button onclick="window.exportPDF()" class="bg-slate-900 text-white px-4 md:px-8 py-3 rounded-xl md:rounded-2xl font-black text-[9px] md:text-[10px] uppercase tracking-widest shadow-lg flex-1 sm:flex-none">Exportar PDF</button>
                </div>
            </div>
            <form id="project-form" oninput="window.setDirty()">
                <input type="hidden" id="edit-id" value=""><input type="hidden" id="impedimento_tipo_list" value="Risco">
                <div class="form-section-box shadow-sm">
                    <label class="label-forte text-slate-300 mb-6 pb-2 border-b border-slate-50 uppercase">1. Identifica√ß√£o Geral</label>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-10">
                        <div class="md:col-span-8"><label class="label-forte">Nome da Iniciativa <span class="text-red-500 font-black">*</span></label><input type="text" id="iniciativa" required class="input-premium uppercase"></div>
                        <div class="md:col-span-4"><label class="label-forte">Prioridade</label><select id="prioridade" class="input-premium font-bold"><option value="Baixa">Baixa</option><option value="M√©dia">M√©dia</option><option value="Alta">Alta</option></select></div>
                    </div>
                </div>
                <div class="form-section-box shadow-sm">
                    <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">2. Defini√ß√£o Operacional</label>
                    <div class="flex flex-wrap items-end gap-4">
                        <div class="flex-1 min-w-[120px]">
                            <div class="flex justify-between items-center mb-1"><label class="label-forte !mb-0">Tipo</label><span class="btn-add-item" onclick="window.openAddModal('tipo_atividade')">+</span></div>
                            <select id="tipo_atividade" required class="input-premium font-bold"><option value="Melhoria" selected>Melhoria</option><option value="Projeto">Projeto</option><option value="Incidente">Incidente</option><option value="Manuten√ß√£o">Manuten√ß√£o</option></select>
                        </div>
                        <div class="flex-1 min-w-[140px]">
                            <div class="flex justify-between items-center mb-1"><label class="label-forte !mb-0">√Årea</label><span class="btn-add-item" onclick="window.openAddModal('time')">+</span></div>
                            <select id="time" required class="input-premium"></select>
                        </div>
                        <div class="flex-1 min-w-[140px]">
                            <div class="flex justify-between items-center mb-1"><label class="label-forte !mb-0">Frente</label><span class="btn-add-item" onclick="window.openAddModal('frente')">+</span></div>
                            <select id="frente" required class="input-premium"></select>
                        </div>
                        <div class="flex-[1.5] min-w-[200px]"><label class="label-forte text-cyan-600">Classifica√ß√£o</label><select id="classificacao" required class="input-premium font-black text-cyan-600"><option value="Efici√™ncia Operacional">Efici√™ncia Operacional</option><option value="Rotina">Rotina</option></select></div>
                        <div class="flex-1 min-w-[100px]"><label class="label-forte">Esfor√ßo</label><select id="esforco" required class="input-premium"><option value="R√°pido">R√°pido</option><option value="Intermedi√°rio">Intermedi√°rio</option><option value="Estruturante">Estruturante</option></select></div>
                        <div class="flex-1 min-w-[130px]"><label class="label-forte">Status</label><select id="status" class="input-premium font-black text-slate-900" onchange="window.updateStatusUI(this.value)"><option value="Backlog">Backlog</option><option value="Em Andamento">Em Andamento</option><option value="Finalizado">Finalizado</option><option value="Despriorizado">Despriorizado</option></select></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <div class="form-section-box shadow-sm">
                        <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">3. Cronograma</label>
                        <div class="grid grid-cols-2 gap-6">
                            <div><label class="label-forte">In√≠cio <span class="text-red-500 font-black">*</span></label><input type="date" id="data_criacao" required class="input-premium text-xs"></div>
                            <div><label class="label-forte">Prazo Estimado <span class="text-red-500 font-black">*</span></label><input type="date" id="prazo" required onchange="window.validatePrazo(this)" class="input-premium text-xs"></div>
                        </div>
                        <div id="closure-dates" class="mt-8 pt-8 border-t border-slate-100 hidden"><label class="label-forte !text-emerald-600">Conclus√£o Realizada</label><input type="date" id="data_conclusao" class="input-premium text-xs border-emerald-100 bg-emerald-50/20 text-slate-900"></div>
                        <div id="deprioritize-box" class="mt-8 pt-8 border-t border-slate-100 hidden"><label class="label-forte !text-red-600">Motivo da Desprioriza√ß√£o</label><textarea id="justificativa_despriorizacao" rows="3" class="input-premium !bg-red-50/10 text-xs" placeholder="Descreva o motivo..."></textarea></div>
                    </div>
                    <div class="form-section-box shadow-sm">
                        <label class="label-forte text-slate-400 mb-6 pb-2 border-b border-slate-50 uppercase">4. Atividades / Tasks</label>
                        <div class="flex justify-between items-center mb-2"><span id="progress-percent" class="text-[10px] font-black text-emerald-600">PROGRESSO: 0%</span></div>
                        <div class="progress-container"><div id="task-progress-bar" class="progress-bar-fill"></div></div>
                        <div id="tasks-list-container" class="space-y-2 mb-4 max-h-48 overflow-y-auto"></div>
                        <div class="flex gap-2"><input type="text" id="new-task-input" class="input-premium !text-xs" placeholder="Nova tarefa..."><button type="button" onclick="window.addTaskToProject()" class="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-[10px] uppercase hover:bg-slate-800 transition-all">Incluir</button></div>
                    </div>
                </div>
                <div class="form-section-box shadow-sm">
                    <div class="flex justify-between items-center mb-8 pb-3 border-b border-slate-50"><label class="label-forte text-slate-400 !mb-0">5. Analistas Respons√°veis <span class="text-red-500 font-black">*</span></label><span class="btn-add-item" onclick="window.openAddModal('analista')">+ Novo</span></div>
                    <div id="responsaveis-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-y-3 gap-x-12 max-h-56 overflow-y-auto pr-2"></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                    <div class="form-section-box shadow-sm space-y-6">
                        <div><label class="label-forte">Descri√ß√£o detalhada <span class="text-red-500 font-black">*</span></label><textarea id="nota_inicial" required rows="4" class="input-premium text-xs leading-relaxed"></textarea></div>
                        <div class="pt-6 border-t border-slate-50">
                            <label class="label-forte">Log de Updates</label>
                            <div id="notes-history-list" class="space-y-3 max-h-56 overflow-y-auto mb-4 pr-3 text-[11px]"></div>
                            <div class="flex flex-col sm:flex-row gap-2"><textarea id="new-milestone-note" rows="4" class="input-premium !text-xs" placeholder="Evolu√ß√£o de hoje..."></textarea><button type="button" onclick="window.addItemToHistory('note')" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-[10px] uppercase hover:bg-slate-800 transition-all self-end">Incluir</button></div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div id="attention-box" class="form-section-box !bg-slate-50 !border-slate-200 transition-colors duration-500">
                            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                                <label class="label-forte !mb-0">Aten√ß√£o Executiva</label>
                                <div class="flex gap-4">
                                    <button type="button" id="toggle-list-risco" onclick="window.setAttentionType('Risco')" class="toggle-btn active-risco">Risco ?</button>
                                    <button type="button" id="toggle-list-problema" onclick="window.setAttentionType('Problema')" class="toggle-btn inactive">Problema ?</button>
                                </div>
                            </div>
                            <div id="attention-history-list" class="space-y-3 max-h-48 overflow-y-auto mb-4 pr-3 text-[11px]"></div>
                            <div class="flex flex-col sm:flex-row gap-2"><textarea id="new-attention-note" rows="3" class="input-premium !bg-white text-xs" placeholder="Novo alerta..."></textarea><button type="button" onclick="window.addItemToHistory('attention')" class="bg-slate-900 text-white px-6 py-2.5 rounded-xl font-bold text-[10px] uppercase hover:bg-slate-800 transition-all self-end">Incluir</button></div>
                        </div>
                    </div>
                </div>
                <div class="pt-10 flex flex-col sm:flex-row gap-4 border-t border-slate-100 no-print pb-10">
                    <button type="submit" class="bg-slate-900 text-white px-12 py-5 rounded-[1.5rem] font-black shadow-2xl flex-1 uppercase text-xs tracking-widest hover:bg-slate-800 transition-all hover:scale-[1.01]">Salvar Projeto</button>
                    <button type="button" onclick="window.trySwitchTab('dashboard');" class="bg-white text-slate-400 border border-slate-200 px-10 py-5 rounded-[1.5rem] font-bold text-xs uppercase hover:bg-slate-50 transition-all">Sair</button>
                </div>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

        // CONFIGURA√á√ÉO DO AMBIENTE (SUBSTITU√çDA PELAS SUAS CREDENCIAIS REAIS)
        const firebaseConfig = {
            apiKey: "AIzaSyAU8nHiRzTwOkrfd8LY7N-YkJG_S7CE0Xs",
            authDomain: "painel-de-projeto.firebaseapp.com",
            projectId: "painel-de-projeto",
            storageBucket: "painel-de-projeto.firebasestorage.app",
            messagingSenderId: "768185401154",
            appId: "1:768185401154:web:d89782c16620a1bf2852db",
            measurementId: "G-CKMHJJ5C37"
        };

        const app = initializeApp(firebaseConfig); 
        const auth = getAuth(app); 
        const db = getFirestore(app);
        const analytics = getAnalytics(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-eficiencia-2026';
        
        let projects = [], configHistory = [], user = null;
        let tempNotes = [], tempTasks = [], tempAttention = [], projectToDeleteId = null, currentTargetField = null, pendingDeleteId = null;
        let charts = {}; let isFormDirty = false; let pendingTab = null;

        const defaultTeam = ["Cauan Pereira Da Silva", "Diego Francisco Rocha", "Hudson Nestor Pereira Cortes", "Lucas Henrique Jantsch", "Luiz Gustavo Ribeiro", "Michael Gabriel Moraes Faria", "Ot√°vio Augusto Oliveira", "Rodrigo Prinz De Paiva", "Simone Thom√© de Andrade"];
        const defaultAreas = ["An√°lise", "CX", "Comunica√ß√£o", "Mesa", "Onboarding"];
        const defaultFrentes = ["Automa√ß√£o", "Performance", "Reestrutura√ß√£o", "Simplifica√ß√£o"];

        window.hideOverlay = () => { const o = document.getElementById('loading-overlay'); if (o) { o.style.opacity = '0'; setTimeout(() => { o.style.display = 'none'; }, 500); } };
        function getBusinessDays(start, end) { let count = 0, cur = new Date(start), target = new Date(end); while (cur <= target) { if (cur.getDay() !== 0 && cur.getDay() !== 6) count++; cur.setDate(cur.getDate() + 1); } return count; }
        window.setDirty = () => { isFormDirty = true; };

        // PLANEJAMENTO
        window.showAddYearModal = () => { document.getElementById('add-year-modal').style.display = 'flex'; };
        window.hideAddYearModal = () => { document.getElementById('add-year-modal').style.display = 'none'; };
        window.confirmAddYear = () => { const val = document.getElementById('new-year-input-planning').value; if(val) { const s = document.getElementById('config-year'); if(!Array.from(s.options).some(o => o.value === val)) s.add(new Option(val, val, true, true)); window.hideAddYearModal(); } };
        window.confirmDeletePeriod = async () => { if(!user || !pendingDeleteId) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_history', pendingDeleteId)); window.hideDeletePeriodModal(); } catch(e) { console.error(e); } };
        window.handlePeriodChange = () => {
            const h = document.getElementById('config-half').value, y = document.getElementById('config-year').value, periodId = `${y}-${h}`;
            const existing = configHistory.find(c => c.id === periodId), metrics = ['analysis', 'call', 'quality', 'sla'];
            metrics.forEach(m => { document.getElementById(`config-baseline-${m}`).value = existing ? (existing[`baseline_${m}`] || 0) : 0; document.getElementById(`config-target-${m}`).value = existing ? (existing[`target_${m}`] || 0) : 0; });
            window.renderConfigHistory();
        };
        window.saveGlobalSettings = async () => {
            if(!user) return;
            const h = document.getElementById('config-half').value, y = document.getElementById('config-year').value, periodId = `${y}-${h}`;
            const data = { id: periodId, year: y, half: h, baseline_analysis: parseFloat(document.getElementById('config-baseline-analysis').value) || 0, target_analysis: parseFloat(document.getElementById('config-target-analysis').value) || 0, baseline_call: parseFloat(document.getElementById('config-baseline-call').value) || 0, target_call: parseFloat(document.getElementById('config-target-call').value) || 0, baseline_quality: parseFloat(document.getElementById('config-baseline-quality').value) || 0, target_quality: parseFloat(document.getElementById('config-target-quality').value) || 0, baseline_sla: parseFloat(document.getElementById('config-baseline-sla').value) || 0, target_sla: parseFloat(document.getElementById('config-target-sla').value) || 0, updatedAt: new Date().toISOString() };
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config_history', periodId), data); document.getElementById('config-success-modal').style.display = 'flex'; } catch(e) { console.error(e); }
        };
        window.renderConfigHistory = () => {
            const container = document.getElementById('config-history-list'); if(!container) return;
            const sorted = [...configHistory].sort((a,b) => b.id.localeCompare(a.id));
            container.innerHTML = sorted.map(c => `<div class="history-card" onclick="window.selectPeriod('${c.year}', '${c.half}')"><div class="flex justify-between items-center mb-4"><span class="text-xl font-black">${c.year} ${c.half}</span></div><div class="space-y-1"><div class="metric-row"><span>An√°lise (R$)</span> <strong>${c.baseline_analysis} ‚Üí ${c.target_analysis}</strong></div><div class="metric-row"><span>Chamado (R$)</span> <strong>${c.baseline_call} ‚Üí ${c.target_call}</strong></div></div></div>`).join('');
        };
        window.selectPeriod = (y, h) => { document.getElementById('config-year').value = y; document.getElementById('config-half').value = h; window.handlePeriodChange(); };

        // DASHBOARD & PROJETOS
        function renderChart(id, type, data, colors) { if(charts[id]) charts[id].destroy(); const canvas = document.getElementById(id); if(!canvas) return; charts[id] = new Chart(canvas.getContext('2d'), { type: type, data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colors, borderWidth: 0, borderRadius: 8 }] }, plugins: [ChartDataLabels], options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'pie', position: 'bottom' }, datalabels: { display: true, font: { weight: 'bold' } } } } }); }
        function updateKPIs(data) {
            const f = data.filter(p => p.status === 'Finalizado');
            document.getElementById('kpi-total').innerText = data.length;
            document.getElementById('kpi-sla').innerText = (f.length ? Math.round((f.filter(p => p.data_conclusao <= p.prazo).length/f.length)*100) : 0) + '%';
        }
        function refreshUI() {
            const activeTab = Array.from(document.querySelectorAll('nav button')).find(b => b.classList.contains('active-tab'))?.id.split('-')[1];
            updateKPIs(projects);
            if(activeTab === 'dashboard') {
                const bk = projects.filter(p => p.status === 'Backlog'), ad = projects.filter(p => p.status === 'Em Andamento');
                document.getElementById('grid-backlog').innerHTML = bk.map(p => `<div class="card-project p-6" style="border-top-color: var(--color-backlog)"><h3 class="font-black uppercase">${p.iniciativa}</h3><button onclick="window.editProjectByID('${p.id}')" class="mt-4 bg-slate-900 text-white w-full py-2 rounded-lg text-[10px]">Gerenciar</button></div>`).join('');
                document.getElementById('grid-andamento').innerHTML = ad.map(p => `<div class="card-project p-6" style="border-top-color: var(--color-andamento)"><h3 class="font-black uppercase">${p.iniciativa}</h3><button onclick="window.editProjectByID('${p.id}')" class="mt-4 bg-slate-900 text-white w-full py-2 rounded-lg text-[10px]">Gerenciar</button></div>`).join('');
            }
        }

        window.renderAnalistaCheckbox = (name, checked = false) => { const g = document.getElementById('responsaveis-grid'); if(!g) return; const l = document.createElement('label'); l.className = "checkbox-item"; l.innerHTML = `<input type="checkbox" name="responsavel_check" value="${name}" ${checked ? 'checked':''}><span>${name}</span>`; g.appendChild(l); };
        window.switchTab = (t) => { ['view-dashboard', 'view-form', 'view-list', 'view-archive', 'view-planning'].forEach(v => { const el = document.getElementById(v); if(el) el.classList.add('hidden'); }); const target = document.getElementById('view-'+t); if(target) target.classList.remove('hidden'); document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active-tab', b.id === `tab-${t}`)); refreshUI(); };
        window.trySwitchTab = (tab) => { if (isFormDirty) { pendingTab = tab; document.getElementById('confirm-exit-modal').style.display = 'flex'; } else { window.switchTab(tab); } };
        window.saveAndExit = () => { document.getElementById('confirm-exit-modal').style.display = 'none'; isFormDirty = false; if(pendingTab) window.switchTab(pendingTab); };
        window.discardAndExit = () => { isFormDirty = false; document.getElementById('confirm-exit-modal').style.display = 'none'; if(pendingTab) window.switchTab(pendingTab); };

        window.editProjectByID = (id) => { const p = projects.find(x => x.id === id); if (!p) return; window.switchTab('form'); document.getElementById('edit-id').value = p.id; document.getElementById('iniciativa').value = p.iniciativa || ''; refreshUI(); };
        window.updateStatusUI = (v) => { const cl = document.getElementById('closure-dates'); if(cl) cl.classList.toggle('hidden', v !== 'Finalizado'); };

        const initAuth = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (e) { window.hideOverlay(); } };
        document.getElementById('project-form').onsubmit = async (e) => { e.preventDefault(); if (!user) return; const id = document.getElementById('edit-id').value; const data = { iniciativa: document.getElementById('iniciativa').value, status: document.getElementById('status').value, time: document.getElementById('time').value, frente: document.getElementById('frente').value, data_criacao: document.getElementById('data_criacao').value, prazo: document.getElementById('prazo').value, nota_inicial: document.getElementById('nota_inicial').value }; try { if (id) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id), data); else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), data); isFormDirty = false; window.switchTab('dashboard'); } catch (err) { console.error(err); } };

        const setup = () => {
            const grid = document.getElementById('responsaveis-grid'); if(grid) grid.innerHTML = '';
            defaultTeam.sort().forEach(n => { window.renderAnalistaCheckbox(n); ['dash-filter-analista', 'list-filter-analista'].forEach(id => { const el = document.getElementById(id); if(el) el.add(new Option(n, n)); }); });
            defaultAreas.sort().forEach(a => { ['time', 'dash-filter-area'].forEach(id => { const el = document.getElementById(id); if(el) el.add(new Option(a, a)); }); });
            defaultFrentes.sort().forEach(f => { ['frente', 'dash-filter-frente'].forEach(id => { const el = document.getElementById(id); if(el) el.add(new Option(f, f)); }); });
        };

        onAuthStateChanged(auth, u => { 
            user = u; 
            if (user) { 
                document.getElementById('sync-indicator')?.classList.remove('hidden');
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), snap => { 
                    projects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
                    window.refreshUI(); 
                    window.hideOverlay(); 
                }, e => { console.error(e); window.hideOverlay(); });
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'config_history'), snap => { 
                    configHistory = snap.docs.map(d => ({ ...d.data() })); 
                    window.renderConfigHistory(); 
                    window.handlePeriodChange(); 
                });
            } else {
                setTimeout(window.hideOverlay, 3000);
            }
        });

        initAuth(); setup();
    </script>
</body>
</html>
