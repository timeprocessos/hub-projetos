<!DOCTYPE html>
<html lang="pt-pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Eficiência Pro - Unico</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Nunito+Sans:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #000a28;
            --accent-color: #00e5ff;
            --bg-body: #f4f7f9;
        }
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--primary-color);
        }
        .input-premium {
            background-color: #ffffff;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.6rem 1rem;
            transition: all 0.2s;
            outline: none;
            font-weight: 700;
            font-size: 0.875rem;
            width: 100%;
        }
        .input-premium:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 4px rgba(0, 229, 255, 0.1);
        }
        .label-forte {
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #475569;
            margin-bottom: 0.4rem;
            display: block;
        }
        .active-tab {
            color: var(--accent-color);
            border-bottom: 4px solid var(--accent-color);
            font-weight: 900;
        }
        .card-project {
            background: white;
            border-radius: 24px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }
        .card-project:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.05);
        }
        .status-pill {
            font-size: 0.6rem;
            font-weight: 900;
            padding: 4px 10px;
            border-radius: 100px;
            text-transform: uppercase;
        }
        .status-backlog { background-color: #e2e8f0; color: #475569; }
        .status-andamento { background-color: #fef3c7; color: #92400e; }
        .status-finalizado { background-color: #dcfce7; color: #166534; }
        .status-despriorizado { background-color: #fee2e2; color: #991b1b; }

        #loading-overlay {
            position: fixed;
            inset: 0;
            background: var(--primary-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            color: white;
            transition: opacity 0.5s;
        }

        .tooltip-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background: #e2e8f0;
            color: #64748b;
            border-radius: 50%;
            font-size: 10px;
            cursor: help;
            margin-left: 4px;
        }

        .toggle-btn {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .toggle-btn.active-risco { background: #fef3c7; border-color: #fbbf24; color: #92400e; }
        .toggle-btn.active-problema { background: #fee2e2; border-color: #ef4444; color: #991b1b; }
        .toggle-btn.inactive { background: #f1f5f9; color: #94a3b8; }

        .form-section-box {
            background: #ffffff;
            border: 1px solid #e2e8f0;
            border-radius: 24px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
        }

        .kpi-card {
            background: white;
            padding: 1rem;
            border-radius: 1rem;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        .checkbox-item:hover { background: #f8fafc; }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <div id="loading-overlay">
        <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="w-32 mb-8 invert" alt="Unico">
        <div class="w-10 h-10 border-4 border-slate-700 border-t-cyan-400 rounded-full animate-spin"></div>
        <p class="text-[10px] uppercase font-bold tracking-widest mt-4 opacity-50 text-white text-center">Sincronizando ambiente Unico...</p>
    </div>

    <header class="bg-white border-b border-slate-100 sticky top-0 z-50 no-print">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center text-slate-800">
            <div class="flex items-center gap-6">
                <img src="https://cloudfilesdm.com/postcards/unico-color__1-878cebbc.png" class="h-6" alt="Unico Logo">
                <div id="sync-indicator" class="hidden md:flex items-center gap-2 px-3 py-1 bg-green-50 rounded-full border border-green-100">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    <span class="text-[9px] font-black text-green-600 uppercase">Tempo Real</span>
                </div>
            </div>
            <nav class="flex gap-6 h-full items-center text-[10px] font-black uppercase tracking-widest text-slate-400">
                <button onclick="window.switchTab('dashboard')" id="tab-dashboard" class="h-full px-2 active-tab transition-colors">Dashboard</button>
                <button onclick="window.switchTab('form')" id="tab-form" class="h-full px-2 hover:text-slate-900 transition-colors text-slate-800">Novo Projeto</button>
                <button onclick="window.switchTab('list')" id="tab-list" class="h-full px-2 hover:text-slate-900 transition-colors text-slate-800">Projetos</button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 mt-4">
        <!-- VIEW DASHBOARD -->
        <div id="view-dashboard" class="block no-print">
            <div class="mb-8 flex flex-col lg:flex-row lg:items-end justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-black tracking-tighter uppercase leading-none">Estratégia & Operação</h1>
                    <p class="text-slate-400 text-[10px] font-bold uppercase mt-2 tracking-widest">Painel de Eficiência Corporativa</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <select id="dash-filter-period" class="input-premium !py-1.5 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="all">Todo o Período</option>
                        <option value="mes">Mensal</option>
                        <option value="trimestre">Trimestral</option>
                        <option value="semestre">Semestral</option>
                        <option value="ano">Anual</option>
                    </select>
                    <select id="dash-filter-analista" class="input-premium !py-1.5 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="">Analistas (Todos)</option>
                    </select>
                    <select id="dash-filter-area" class="input-premium !py-1.5 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="">Áreas (Todas)</option>
                    </select>
                    <select id="dash-filter-frente" class="input-premium !py-1.5 !text-[10px] !w-auto shadow-sm" onchange="window.refreshUI()">
                        <option value="">Frentes (Todas)</option>
                    </select>
                </div>
            </div>

            <!-- KPIs -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
                <div class="kpi-card"><p class="label-forte">Total</p><h2 id="kpi-total" class="text-xl font-black text-slate-900">0</h2></div>
                <div class="kpi-card"><p class="label-forte text-cyan-600">SLA Geral</p><h2 id="kpi-sla" class="text-xl font-black text-cyan-600">0%</h2></div>
                <div class="kpi-card"><p class="label-forte text-green-600">No Prazo</p><h2 id="kpi-concluidos-prazo" class="text-xl font-black text-green-600">0</h2></div>
                <div class="kpi-card"><p class="label-forte text-blue-600">Riscos</p><h2 id="kpi-riscos" class="text-xl font-black text-blue-600">0</h2></div>
                <div class="kpi-card"><p class="label-forte text-red-600">Problemas</p><h2 id="kpi-problemas" class="text-xl font-black text-red-600">0</h2></div>
                <div class="kpi-card"><p class="label-forte text-indigo-600">Saúde</p><h2 id="kpi-saude" class="text-xl font-black text-indigo-600">100%</h2></div>
            </div>

            <!-- LINHA DIVISÓRIA FINA -->
            <div class="h-px bg-slate-200 w-full mb-10"></div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte">Status</span><div class="w-full h-48 mt-2"><canvas id="chartStatus"></canvas></div></div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte">Esforço: Rotina vs Inovação</span><div class="w-full h-48 mt-2"><canvas id="chartTime"></canvas></div></div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte">Frentes</span><div class="w-full h-48 mt-2"><canvas id="chartFrente"></canvas></div></div>
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex flex-col items-center"><span class="label-forte">Média Tempo Conclusão (Dias)</span><div class="w-full h-48 mt-2"><canvas id="chartAvgCompletion"></canvas></div></div>
            </div>

            <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- VIEW LISTA (PROJETOS) -->
        <div id="view-list" class="hidden no-print">
            <div class="mb-8 flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
                <div>
                    <h1 class="text-3xl font-black tracking-tighter uppercase leading-none">Controle de Projetos</h1>
                    <p class="text-slate-400 text-[10px] font-bold uppercase mt-2 tracking-widest">Visão detalhada do cronograma e equipe</p>
                </div>
                <div class="flex flex-wrap gap-2">
                    <select id="list-filter-area" class="input-premium !py-1.5 !text-[10px] !w-auto" onchange="window.refreshUI()"><option value="">Todas as Áreas</option></select>
                    <select id="list-filter-status" class="input-premium !py-1.5 !text-[10px] !w-auto" onchange="window.refreshUI()">
                        <option value="">Todos Status</option>
                        <option value="Backlog">Backlog</option>
                        <option value="Em Andamento">Em Andamento</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Despriorizado">Despriorizado</option>
                    </select>
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-slate-100 overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b border-slate-100 text-[9px] font-black uppercase tracking-widest text-slate-400">
                        <tr>
                            <th class="p-6">Iniciativa</th>
                            <th class="p-6">Área</th>
                            <th class="p-6">Tipo</th>
                            <th class="p-6">Prazo Target</th>
                            <th class="p-6 text-center">Status</th>
                            <th class="p-6 text-right">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="detailed-table-body" class="divide-y divide-slate-50 text-[11px] font-bold text-slate-700"></tbody>
                </table>
            </div>
        </div>

        <!-- FORMULÁRIO -->
        <div id="view-form" class="hidden max-w-6xl mx-auto">
            <div class="mb-8">
                <h2 id="form-title" class="text-2xl font-black uppercase tracking-tighter text-slate-800">Ficha Técnica da Iniciativa</h2>
            </div>
            
            <form id="project-form" class="space-y-6">
                <input type="hidden" id="edit-id" value="">
                <input type="hidden" id="impedimento_tipo" value="nenhum">

                <!-- BLOCO 1: IDENTIFICAÇÃO E OPERAÇÃO -->
                <div class="form-section-box">
                    <label class="label-forte !text-slate-400 mb-4 pb-2 border-b border-slate-50">Identificação e Operação</label>
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div class="md:col-span-6">
                            <label class="label-forte">Nome da Iniciativa</label>
                            <input type="text" id="iniciativa" required class="input-premium uppercase" placeholder="PROJETO X...">
                        </div>
                        <div class="md:col-span-3">
                            <label class="label-forte">Tipo <span class="tooltip-icon" title="Incidente/Manutenção: Rotina | Melhoria/Projeto: Evolução">?</span></label>
                            <select id="tipo_atividade" required class="input-premium font-bold">
                                <option value="Incidente">Incidente</option>
                                <option value="Manutenção">Manutenção</option>
                                <option value="Melhoria" selected>Melhoria</option>
                                <option value="Projeto">Projeto</option>
                            </select>
                        </div>
                        <div class="md:col-span-3">
                            <label class="label-forte">Prioridade</label>
                            <select id="prioridade" class="input-premium font-bold">
                                <option value="Baixa">Baixa</option>
                                <option value="Média">Média</option>
                                <option value="Alta">Alta</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 mt-6">
                        <div><label class="label-forte">Área Impactada</label><select id="time" required class="input-premium"></select></div>
                        <div><label class="label-forte">Frente Trabalho</label><select id="frente" required class="input-premium"></select></div>
                        <div><label class="label-forte">Esforço Estimado</label><select id="esforco" required class="input-premium font-bold"><option value="Rápido">Rápido</option><option value="Intermediário">Intermediário</option><option value="Estruturante">Estruturante</option></select></div>
                        <div><label class="label-forte">Status Atual</label><select id="status" class="input-premium font-black" onchange="window.updateStatusUI(this.value)"><option value="Backlog">Backlog</option><option value="Em Andamento">Em Andamento</option><option value="Finalizado">Finalizado</option><option value="Despriorizado">Despriorizado</option></select></div>
                    </div>
                </div>

                <!-- BLOCO 2: CRONOGRAMA E KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                    <div class="md:col-span-5 form-section-box">
                        <label class="label-forte !text-slate-400 mb-4 pb-2 border-b border-slate-50">Cronograma</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="label-forte">Início</label><input type="date" id="data_criacao" required class="input-premium text-xs"></div>
                            <div><label class="label-forte">Prazo Final</label><input type="date" id="prazo" required class="input-premium text-xs"></div>
                        </div>
                        <div id="closure-dates" class="mt-4 pt-4 border-t border-slate-100 hidden">
                            <div><label class="label-forte !text-green-600">Data Conclusão</label><input type="date" id="data_conclusao" class="input-premium text-xs border-green-200"></div>
                        </div>
                    </div>
                    <div class="md:col-span-7 form-section-box">
                        <label class="label-forte !text-slate-400 mb-4 pb-2 border-b border-slate-50">KPIs de Sucesso</label>
                        <div id="metricas-container" class="space-y-3 mb-4"></div>
                        <button type="button" onclick="window.addMetricaInput()" class="text-[9px] font-black text-cyan-500 uppercase tracking-widest">+ Adicionar KPI</button>
                    </div>
                </div>

                <!-- BLOCO 3: RESPONSÁVEIS -->
                <div class="form-section-box">
                    <label class="label-forte !text-slate-400 mb-4 pb-2 border-b border-slate-50">Responsáveis Líderes</label>
                    <div id="responsaveis-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 max-h-40 overflow-y-auto"></div>
                </div>

                <!-- BLOCO 4: DETALHAMENTO E IMPEDIMENTOS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-section-box space-y-6">
                        <div><label class="label-forte !text-slate-400 mb-4">Escopo e Objetivo</label><textarea id="nota_inicial" rows="4" class="input-premium text-xs leading-relaxed" placeholder="Qual o propósito estratégico..."></textarea></div>
                        <div class="pt-4 border-t border-slate-50">
                            <label class="label-forte !text-slate-400 mb-4">Atividades</label>
                            <div class="flex gap-2 mb-4"><input type="text" id="task-input" placeholder="O que fazer?" class="flex-1 input-premium !py-1.5 !text-xs"><button type="button" onclick="window.addTaskToList()" class="bg-slate-900 text-white px-3 rounded-lg font-bold">+</button></div>
                            <div id="tasks-container" class="space-y-2 max-h-40 overflow-y-auto"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div class="form-section-box !bg-red-50/10 !border-red-100">
                            <div class="flex justify-between items-center mb-4">
                                <label class="label-forte !mb-0 text-red-600">Impedimentos / Riscos</label>
                                <div class="flex gap-2">
                                    <button type="button" id="toggle-risco" onclick="window.setImpedimentoTipo('Risco')" class="toggle-btn inactive">Risco ?</button>
                                    <button type="button" id="toggle-problema" onclick="window.setImpedimentoTipo('Problema')" class="toggle-btn inactive">Problema ?</button>
                                </div>
                            </div>
                            <textarea id="impedimentos" rows="3" class="input-premium !bg-white !border-red-50 text-xs" placeholder="Obstáculos travando a execução..."></textarea>
                        </div>
                        
                        <div class="form-section-box">
                            <label class="label-forte !text-slate-400 mb-4">Lições Aprendidas</label>
                            <textarea id="licoes_aprendidas" rows="3" class="input-premium text-xs" placeholder="Registre o conhecimento gerado..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- BLOCO 5: HISTÓRICO (SOMENTE EDIÇÃO) -->
                <div id="notes-section" class="hidden form-section-box">
                    <label class="label-forte !text-slate-400 mb-4">Evolução</label>
                    <div id="notes-history-list" class="space-y-2 max-h-40 overflow-y-auto mb-4 pr-1"></div>
                    <input type="text" id="new-milestone-note" class="input-premium !py-1.5 !text-xs" placeholder="Nova atualização rápida...">
                </div>

                <div class="pt-8 flex flex-wrap gap-4 border-t border-slate-100">
                    <button type="submit" class="bg-slate-900 text-white px-8 py-4 rounded-2xl font-black shadow-lg flex-1 uppercase text-[10px] tracking-widest hover:bg-slate-800 transition">Salvar Iniciativa</button>
                    <button type="button" onclick="window.resetForm(); window.switchTab('dashboard');" class="bg-white text-slate-400 border border-slate-200 px-6 py-4 rounded-2xl font-bold text-[10px] uppercase">Voltar</button>
                    <button type="button" id="btn-delete" class="hidden bg-red-50 text-red-600 px-6 py-4 rounded-2xl font-bold text-[10px] uppercase hover:bg-red-100 transition" onclick="window.deleteProject()">Excluir</button>
                </div>
            </form>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // CONFIGURAÇÕES GLOBAIS
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'unico-v2-intel';
        
        let projects = [];
        let charts = {};
        let currentTasks = [];
        let user = null;

        const defaultTeam = ["Cauan Pereira", "Diego Rocha", "Hudson Cortes", "Lucas Henrique", "Luiz Gustavo", "Michael Gabriel", "Otávio Augusto", "Rodrigo Prinz", "Simone Thomé"];
        const defaultAreas = ["Análise", "CX", "Mesa", "Onboarding", "Comunicação"];
        const defaultFrentes = ["Performance", "Reestruturação", "Automação", "Simplificação"];

        // --- FUNÇÃO PARA OCULTAR O LOADER ---
        const hideOverlay = () => {
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.style.opacity = '0';
                setTimeout(() => overlay.style.display = 'none', 500);
            }
        };

        // Fail-safe: Oculta o carregamento após 5 segundos independente do banco
        setTimeout(hideOverlay, 5000);

        // --- AUTH & SYNC ---
        const init = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth initialization failed:", error);
                hideOverlay();
            }
        };

        onAuthStateChanged(auth, u => {
            user = u;
            if (user) {
                document.getElementById('sync-indicator').classList.remove('hidden');
                setupSnapshots();
            }
        });

        const setupSnapshots = () => {
            if (!user) return;
            const path = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
            onSnapshot(path, snap => {
                    projects = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    hideOverlay();
                    window.refreshUI();
                },
                error => {
                    console.error("Firestore Snapshot error:", error);
                    hideOverlay(); // Garante que a tela suma mesmo se der erro
                }
            );
        };

        // --- CALCULO DIAS ÚTEIS ---
        window.getBusinessDays = (startDate, endDate) => {
            let count = 0;
            let curDate = new Date(startDate);
            const targetDate = new Date(endDate);
            while (curDate <= targetDate) {
                const dayOfWeek = curDate.getDay();
                if (dayOfWeek !== 0 && dayOfWeek !== 6) count++;
                curDate.setDate(curDate.getDate() + 1);
            }
            return count;
        };

        // --- LÓGICA DE NEGÓCIO ---
        window.setImpedimentoTipo = (tipo) => {
            const current = document.getElementById('impedimento_tipo').value;
            const newVal = current === tipo ? 'nenhum' : tipo;
            document.getElementById('impedimento_tipo').value = newVal;
            document.getElementById('toggle-risco').className = `toggle-btn ${newVal === 'Risco' ? 'active-risco' : 'inactive'}`;
            document.getElementById('toggle-problema').className = `toggle-btn ${newVal === 'Problema' ? 'active-problema' : 'inactive'}`;
        };

        const isProjectInPeriod = (dateStr, period) => {
            if (period === 'all') return true;
            if (!dateStr) return false;
            const date = new Date(dateStr);
            const now = new Date();
            if (period === 'mes') return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            if (period === 'trimestre') {
                const q = Math.floor(now.getMonth() / 3);
                const pq = Math.floor(date.getMonth() / 3);
                return q === pq && date.getFullYear() === now.getFullYear();
            }
            if (period === 'semestre') {
                const s = Math.floor(now.getMonth() / 6);
                const ps = Math.floor(date.getMonth() / 6);
                return s === ps && date.getFullYear() === now.getFullYear();
            }
            if (period === 'ano') return date.getFullYear() === now.getFullYear();
            return true;
        };

        window.updateKPIs = (data) => {
            const finished = data.filter(p => p.status === 'Finalizado');
            const active = data.filter(p => p.status !== 'Finalizado' && p.status !== 'Despriorizado');
            const onTime = finished.filter(p => p.data_conclusao && p.prazo && new Date(p.data_conclusao) <= new Date(p.prazo));
            const riscosCount = active.filter(p => p.impedimento_tipo === 'Risco').length;
            const problemasCount = active.filter(p => p.impedimento_tipo === 'Problema').length;
            
            let saude = 100;
            if (problemasCount === 1) saude = 50;
            else if (problemasCount >= 2) saude = 0;

            document.getElementById('kpi-total').innerText = data.length;
            document.getElementById('kpi-sla').innerText = (finished.length ? Math.round((onTime.length/finished.length)*100) : 0) + '%';
            document.getElementById('kpi-concluidos-prazo').innerText = onTime.length;
            document.getElementById('kpi-riscos').innerText = riscosCount;
            document.getElementById('kpi-problemas').innerText = problemasCount;
            const saudeEl = document.getElementById('kpi-saude');
            saudeEl.innerText = saude + '%';
            saudeEl.className = `text-xl font-black ${saude === 100 ? 'text-green-500' : (saude === 50 ? 'text-amber-500' : 'text-red-500')}`;
        };

        window.renderDashboard = (data) => {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';
            const activeOnly = data.filter(p => p.status !== 'Finalizado' && p.status !== 'Despriorizado');
            activeOnly.forEach(p => {
                const isProblema = p.impedimento_tipo === 'Problema';
                const borderClass = isProblema ? 'border-2 border-red-500' : 'border border-slate-100';
                const statusSlug = (p.status || 'backlog').toLowerCase().replace(/\s/g, '');
                grid.innerHTML += `
                    <div class="card-project p-6 flex flex-col h-full border-t-[10px] ${borderClass}" style="border-top-color: ${isProblema ? '#ef4444' : (p.tipo_atividade === 'Projeto' ? '#00e5ff' : '#000a28')}">
                        <div class="flex justify-between items-start mb-4">
                            <span class="text-[8px] font-black text-slate-400 uppercase tracking-widest">${p.tipo_atividade} | ${p.time}</span>
                            <span class="status-pill status-${statusSlug}">${p.status}</span>
                        </div>
                        <h3 class="text-lg font-black mb-3 uppercase line-clamp-2 leading-tight">${p.iniciativa}</h3>
                        ${p.impedimentos ? `<div class="mb-3 p-2 rounded-lg text-[9px] font-bold ${isProblema ? 'bg-red-50 text-red-600' : 'bg-amber-50 text-amber-600'}">${p.impedimentos}</div>` : ''}
                        <div class="text-[10px] font-bold space-y-2 mb-4 text-slate-500"><p class="flex justify-between"><span>PRAZO:</span> <span class="text-slate-900 font-black">${p.prazo ? p.prazo.split('-').reverse().join('/') : '---'}</span></p></div>
                        <button onclick="window.editProjectByID('${p.id}')" class="bg-slate-900 text-white py-3 rounded-xl font-black uppercase text-[9px] tracking-widest hover:bg-slate-800 transition mt-auto">Gerenciar</button>
                    </div>`;
            });
        };

        window.renderDetailedList = (data) => {
            const tbody = document.getElementById('detailed-table-body');
            tbody.innerHTML = '';
            data.forEach(p => {
                const statusSlug = (p.status || 'backlog').toLowerCase().replace(/\s/g, '');
                tbody.innerHTML += `
                    <tr>
                        <td class="p-6 uppercase">${p.iniciativa}</td>
                        <td class="p-6 text-slate-500">${p.time}</td>
                        <td class="p-6 text-slate-400 uppercase text-[9px]">${p.tipo_atividade}</td>
                        <td class="p-6">${p.prazo ? p.prazo.split('-').reverse().join('/') : '--'}</td>
                        <td class="p-6 text-center"><span class="status-pill status-${statusSlug}">${p.status}</span></td>
                        <td class="p-6 text-right"><button onclick="window.editProjectByID('${p.id}')" class="text-cyan-500 hover:underline uppercase text-[9px] font-black">Editar</button></td>
                    </tr>`;
            });
        };

        window.updateCharts = (data) => {
            const statusCounts = data.reduce((a,v) => { a[v.status] = (a[v.status]||0)+1; return a; }, {});
            window.renderChart('chartStatus', 'pie', statusCounts, ['#e2e8f0', '#fef3c7', '#dcfce7', '#fee2e2']);
            
            const areas = Array.from(new Set(data.map(p => p.time))).sort();
            if(charts['chartTime']) charts['chartTime'].destroy();
            const ctxTime = document.getElementById('chartTime')?.getContext('2d');
            if(ctxTime) {
                charts['chartTime'] = new Chart(ctxTime, { type: 'bar', data: { labels: areas, datasets: [
                    { label: 'Rotina', data: areas.map(a => data.filter(p => p.time === a && (p.tipo_atividade === 'Incidente' || p.tipo_atividade === 'Manutenção')).length), backgroundColor: '#94a3b8' },
                    { label: 'Inovação', data: areas.map(a => data.filter(p => p.time === a && (p.tipo_atividade === 'Melhoria' || p.tipo_atividade === 'Projeto')).length), backgroundColor: '#00e5ff' }
                ]}, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }});
            }

            const frenteCounts = data.reduce((a,v) => { a[v.frente||'N/A'] = (a[v.frente||'N/A']||0)+1; return a; }, {});
            window.renderChart('chartFrente', 'bar', frenteCounts, ['#000a28', '#00e5ff', '#fbbf24', '#f8fafc']);

            // GRÁFICO MÉDIA CONCLUSÃO
            const concluidos = data.filter(p => p.status === 'Finalizado' && p.data_criacao && p.data_conclusao);
            let avgCorridos = 0, avgUteis = 0;
            if(concluidos.length) {
                const totalCorridos = concluidos.reduce((acc, p) => acc + (new Date(p.data_conclusao) - new Date(p.data_criacao)) / (1000 * 60 * 60 * 24), 0);
                const totalUteis = concluidos.reduce((acc, p) => acc + window.getBusinessDays(p.data_criacao, p.data_conclusao), 0);
                avgCorridos = (totalCorridos / concluidos.length).toFixed(1);
                avgUteis = (totalUteis / concluidos.length).toFixed(1);
            }

            if(charts['chartAvgCompletion']) charts['chartAvgCompletion'].destroy();
            const ctxAvg = document.getElementById('chartAvgCompletion')?.getContext('2d');
            if(ctxAvg) {
                charts['chartAvgCompletion'] = new Chart(ctxAvg, {
                    type: 'bar',
                    data: {
                        labels: ['Dias Corridos', 'Dias Úteis'],
                        datasets: [{
                            data: [avgCorridos, avgUteis],
                            backgroundColor: ['#64748b', '#00e5ff'],
                            borderRadius: 8
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
                });
            }
        };

        window.renderChart = (id, type, data, colors) => {
            if(charts[id]) charts[id].destroy();
            const canvas = document.getElementById(id); if(!canvas) return;
            charts[id] = new Chart(canvas.getContext('2d'), { type: type, data: { labels: Object.keys(data), datasets: [{ data: Object.values(data), backgroundColor: colors, borderWidth: 0, borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: type === 'pie', position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } } } } });
        };

        window.refreshUI = () => {
            const tab = document.querySelector('.active-tab')?.id.split('-')[1] || 'dashboard';
            const period = document.getElementById('dash-filter-period').value;
            const analista = document.getElementById('dash-filter-analista').value;
            const area = document.getElementById('dash-filter-area').value;
            const frente = document.getElementById('dash-filter-frente').value;

            let filtered = projects.filter(p => {
                const inPeriod = isProjectInPeriod(p.data_criacao, period);
                const matchAnalista = !analista || (p.responsavel && p.responsavel.includes(analista));
                const matchArea = !area || p.time === area;
                const matchFrente = !frente || p.frente === frente;
                return inPeriod && matchAnalista && matchArea && matchFrente;
            });

            if (tab === 'list') {
                const listArea = document.getElementById('list-filter-area').value;
                const listStatus = document.getElementById('list-filter-status').value;
                let listFiltered = filtered.filter(p => (!listArea || p.time === listArea) && (!listStatus || p.status === listStatus));
                window.renderDetailedList(listFiltered);
            }

            window.updateKPIs(filtered);
            window.renderDashboard(filtered);
            window.updateCharts(filtered);
        };

        // --- NAVEGAÇÃO ---
        window.switchTab = (t) => {
            document.getElementById('view-dashboard').classList.toggle('hidden', t !== 'dashboard');
            document.getElementById('view-form').classList.toggle('hidden', t !== 'form');
            document.getElementById('view-list').classList.toggle('hidden', t !== 'list');
            document.querySelectorAll('nav button').forEach(b => b.classList.toggle('active-tab', b.id === `tab-${t}`));
            if (t !== 'form') window.resetForm();
            window.refreshUI();
        };

        // --- FORMULÁRIO ---
        window.addTaskToList = () => {
            const inp = document.getElementById('task-input');
            if (!inp.value.trim()) return;
            currentTasks.push({ id: Date.now(), text: inp.value.trim(), completed: false });
            inp.value = '';
            window.renderTasksList();
        };

        window.toggleTask = (id) => {
            currentTasks = currentTasks.map(t => t.id === id ? {...t, completed: !t.completed} : t);
            window.renderTasksList();
        };

        window.renderTasksList = () => {
            const container = document.getElementById('tasks-container');
            if (!container) return;
            container.innerHTML = '';
            currentTasks.forEach(t => {
                container.innerHTML += `<div class="flex items-center gap-3 p-2 bg-white border border-slate-100 rounded-xl mb-1 shadow-sm"><input type="checkbox" ${t.completed ? 'checked' : ''} onchange="window.toggleTask(${t.id})" class="w-3 h-3 text-cyan-500"><span class="flex-1 text-[11px] font-bold ${t.completed ? 'line-through text-slate-300' : 'text-slate-700'}">${t.text}</span></div>`;
            });
        };

        window.addMetricaInput = (l='', m='', r='', t='Ganho') => {
            const container = document.getElementById('metricas-container');
            if (!container) return;
            const div = document.createElement('div');
            div.className = 'grid grid-cols-6 gap-2 items-end';
            div.innerHTML = `<div class="col-span-3"><input type="text" placeholder="KPI" class="metrica-label input-premium !py-1 !text-[9px] uppercase" value="${l}"></div><div><input type="text" placeholder="Meta" class="metrica-meta input-premium !py-1 !text-[9px]" value="${m}"></div><div><input type="text" placeholder="Real" class="metrica-real input-premium !py-1 !text-[9px]" value="${r}"></div><button type="button" onclick="this.parentElement.remove()" class="text-red-300 pb-1 font-bold">×</button>`;
            container.appendChild(div);
        };

        window.resetForm = () => {
            document.getElementById('project-form').reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('metricas-container').innerHTML = '';
            document.getElementById('notes-section').classList.add('hidden');
            document.getElementById('btn-delete').classList.add('hidden');
            currentTasks = [];
            window.renderTasksList();
            window.addMetricaInput();
            window.setImpedimentoTipo('nenhum');
        };

        window.updateStatusUI = (v) => {
            document.getElementById('closure-dates').classList.toggle('hidden', v !== 'Finalizado');
        };

        window.editProjectByID = (id) => {
            const p = projects.find(x => x.id === id);
            if (!p) return;
            window.switchTab('form');
            document.getElementById('edit-id').value = p.id;
            document.getElementById('iniciativa').value = p.iniciativa || '';
            document.getElementById('tipo_atividade').value = p.tipo_atividade || 'Melhoria';
            document.getElementById('prioridade').value = p.prioridade || 'Média';
            document.getElementById('time').value = p.time || '';
            document.getElementById('frente').value = p.frente || '';
            document.getElementById('esforco').value = p.esforco || 'Intermediário';
            document.getElementById('status').value = p.status || 'Backlog';
            document.getElementById('data_criacao').value = p.data_criacao || '';
            document.getElementById('prazo').value = p.prazo || '';
            document.getElementById('impedimentos').value = p.impedimentos || '';
            document.getElementById('nota_inicial').value = p.nota_inicial || '';
            document.getElementById('licoes_aprendidas').value = p.licoes_aprendidas || '';
            document.getElementById('btn-delete').classList.remove('hidden');

            window.setImpedimentoTipo(p.impedimento_tipo || 'nenhum');
            window.updateStatusUI(p.status);
            currentTasks = p.atividades || [];
            window.renderTasksList();
            
            const mC = document.getElementById('metricas-container');
            if (mC) mC.innerHTML = '';
            if (p.metricas?.length) p.metricas.forEach(m => window.addMetricaInput(m.label, m.meta, m.real, m.type));
            else window.addMetricaInput();
            
            document.querySelectorAll('input[name="responsavel_check"]').forEach(cb => { cb.checked = p.responsavel?.includes(cb.value); });
            
            const notesS = document.getElementById('notes-section');
            notesS.classList.remove('hidden');
            const hist = document.getElementById('notes-history-list');
            hist.innerHTML = '';
            (p.notes || []).forEach(n => hist.innerHTML += `<div class="p-2 bg-slate-50 rounded-lg text-[9px] font-bold border border-slate-100"><span class="text-cyan-500">${n.date}:</span> ${n.text}</div>`);
        };

        window.deleteProject = async () => {
            const id = document.getElementById('edit-id').value;
            if (!id || !user) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id));
                window.switchTab('dashboard');
            } catch (err) { console.error("Delete error:", err); }
        };

        document.getElementById('project-form').onsubmit = async (e) => {
            e.preventDefault();
            if (!user) return;
            const id = document.getElementById('edit-id').value;
            const data = {
                iniciativa: document.getElementById('iniciativa').value,
                tipo_atividade: document.getElementById('tipo_atividade').value,
                prioridade: document.getElementById('prioridade').value,
                time: document.getElementById('time').value,
                frente: document.getElementById('frente').value,
                esforco: document.getElementById('esforco').value,
                status: document.getElementById('status').value,
                data_criacao: document.getElementById('data_criacao').value,
                prazo: document.getElementById('prazo').value,
                impedimentos: document.getElementById('impedimentos').value,
                impedimento_tipo: document.getElementById('impedimento_tipo').value,
                nota_inicial: document.getElementById('nota_inicial').value,
                licoes_aprendidas: document.getElementById('licoes_aprendidas').value,
                responsavel: Array.from(document.querySelectorAll('input[name="responsavel_check"]:checked')).map(cb => cb.value),
                atividades: currentTasks,
                metricas: Array.from(document.querySelectorAll('#metricas-container > div')).map(row => ({
                    label: row.querySelector('.metrica-label').value,
                    meta: row.querySelector('.metrica-meta').value,
                    real: row.querySelector('.metrica-real').value
                }))
            };

            if (data.status === 'Finalizado' && !data.data_conclusao) {
                data.data_conclusao = new Date().toISOString().split('T')[0];
            }

            try {
                if (id) {
                    const existing = projects.find(p => p.id === id);
                    const notes = existing?.notes || [];
                    const noteText = document.getElementById('new-milestone-note')?.value;
                    if (noteText) notes.push({ date: new Date().toLocaleDateString('pt-BR'), text: noteText });
                    data.notes = notes;
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'projects', id), data);
                } else {
                    data.notes = [];
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'projects'), data);
                }
                window.switchTab('dashboard');
            } catch (err) { console.error("Save error:", err); }
        };

        // --- INICIALIZAÇÃO ---
        init();
        const renderCheckboxes = () => {
            const grid = document.getElementById('responsaveis-grid');
            defaultTeam.forEach(name => {
                grid.innerHTML += `<label class="checkbox-item text-[10px] font-bold text-slate-600"><input type="checkbox" name="responsavel_check" value="${name}" class="w-3.5 h-3.5 accent-cyan-500"><span>${name}</span></label>`;
            });
        };
        const setupDropdowns = () => {
            const areaSel = document.getElementById('time');
            const listAreaSel = document.getElementById('list-filter-area');
            const dashAreaSel = document.getElementById('dash-filter-area');
            const dashAnalistaSel = document.getElementById('dash-filter-analista');
            const dashFrenteSel = document.getElementById('dash-filter-frente');
            
            defaultAreas.forEach(a => {
                areaSel.innerHTML += `<option value="${a}">${a}</option>`;
                listAreaSel.innerHTML += `<option value="${a}">${a}</option>`;
                dashAreaSel.innerHTML += `<option value="${a}">${a}</option>`;
            });
            
            defaultTeam.forEach(t => {
                dashAnalistaSel.innerHTML += `<option value="${t}">${t}</option>`;
            });

            defaultFrentes.forEach(f => {
                document.getElementById('frente').innerHTML += `<option value="${f}">${f}</option>`;
                dashFrenteSel.innerHTML += `<option value="${f}">${f}</option>`;
            });
        };
        renderCheckboxes();
        setupDropdowns();
        window.addMetricaInput();
    </script>
</body>
</html>
